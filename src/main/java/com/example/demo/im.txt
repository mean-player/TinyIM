==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\DemoApplication.java ====
package com.example.demo;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.scheduling.annotation.EnableAsync;

@SpringBootApplication
public class DemoApplication {

	public static void main(String[] args) {
		SpringApplication.run(DemoApplication.class, args);
	}

}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\AOP\LimitApplication.java ====
package com.example.demo.AOP;


import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface LimitApplication {}

==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\AOP\LimitAvatar.java ====
package com.example.demo.AOP;

import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface LimitAvatar {}

==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\AOP\LimitCreateGroup.java ====
package com.example.demo.AOP;

import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface LimitCreateGroup {}

==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\AOP\LimitMessageSend.java ====
package com.example.demo.AOP;

import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface LimitMessageSend {}

==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\AOP\LimitNickname.java ====
package com.example.demo.AOP;


import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface LimitNickname {}

==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\AOP\LimitPWReset.java ====
package com.example.demo.AOP;

import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;


@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface LimitPWReset {}

==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\AOP\LimitSignature.java ====
package com.example.demo.AOP;


import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface LimitSignature {}

==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\AOP\LimitUpload.java ====
package com.example.demo.AOP;

import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface LimitUpload {}

==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\AOP\RateLimitAspect.java ====
package com.example.demo.AOP;

import com.example.demo.Service.RateLimitService;
import com.example.demo.Tools.AuthUtil;
import com.example.demo.common.exception.BusinessException;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.annotation.Around;
import org.aspectj.lang.annotation.Aspect;
import org.springframework.stereotype.Component;

@Aspect
@Component
@RequiredArgsConstructor
@Slf4j
public class RateLimitAspect {

    private static final int STATUS_UNAUTHORIZED = 401;
    private static final int STATUS_TOO_MANY_REQUESTS = 429;

    private final RateLimitService rateLimitService;

    @Around("@annotation(limitAvatar) || @annotation(limitNickname) || @annotation(limitCreateGroup) ||" +
            "@annotation(limitSignature) || @annotation(limitApplication) || @annotation(limitMessageSend) ||" +
            "@annotation(limitUpload) || @annotation(limitPWReset)")
    public Object checkLimit(ProceedingJoinPoint joinPoint,
                             LimitAvatar limitAvatar,
                             LimitNickname limitNickname,
                             LimitCreateGroup limitCreateGroup,
                             LimitSignature limitSignature,
                             LimitApplication limitApplication,
                             LimitMessageSend limitMessageSend,
                             LimitUpload limitUpload,
                             LimitPWReset limitPWReset) throws Throwable {

        String userId = AuthUtil.getUserId();
        if (userId == null) {
            throw new BusinessException(STATUS_UNAUTHORIZED, "未认证的用户");
        }

        if (limitAvatar != null) {
            if (!rateLimitService.canChangeAvatar(userId)) {
                throw new BusinessException(STATUS_TOO_MANY_REQUESTS, "今日头像修改次数已用完");
            }
        }
        if (limitNickname != null) {
            if (!rateLimitService.canChangeNickname(userId)) {
                throw new BusinessException(STATUS_TOO_MANY_REQUESTS, "昵称修改过于频繁");
            }
        }
        if (limitSignature != null) {
            if (!rateLimitService.canChangeSignature(userId)) {
                throw new BusinessException(STATUS_TOO_MANY_REQUESTS, "签名修改过于频繁");
            }
        }
        if (limitApplication != null) {
            if (!rateLimitService.canSendApplication(userId)) {
                throw new BusinessException(STATUS_TOO_MANY_REQUESTS, "发送申请过于频繁");
            }
        }
        if (limitCreateGroup != null) {
            if (!rateLimitService.canCreateGroup(userId)) {
                throw new BusinessException(STATUS_TOO_MANY_REQUESTS, "创建群组过于频繁");
            }
        }
        if (limitMessageSend != null) {
            if (!rateLimitService.canSendMessage(userId)) {
                log.warn("RateLimit sendMessage exceeded userId={}", userId);
                throw new BusinessException(STATUS_TOO_MANY_REQUESTS, "发消息过于频繁");
            }
        }
        if (limitUpload != null) {
            if (!rateLimitService.canUpload(userId)) {
                log.warn("RateLimit upload exceeded userId={}", userId);
                throw new BusinessException(STATUS_TOO_MANY_REQUESTS, "上传文件过于频繁");
            }
        }
        if (limitPWReset != null) {
            if (!rateLimitService.canResetPassword(userId)) {
                log.warn("RateLimit password reset exceeded userId={}", userId);
                throw new BusinessException(STATUS_TOO_MANY_REQUESTS, "修改密码过于频繁");
            }
        }

        return joinPoint.proceed();
    }
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\common\exception\BusinessException.java ====

package com.example.demo.common.exception;
import lombok.Getter;

@Getter
public class BusinessException extends RuntimeException {

    private final int code;

    public BusinessException(int code, String message) {
        super(message);
        this.code = code;
    }
}



==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\common\exception\GlobalExceptionHandler.java ====
package com.example.demo.common.exception;

import com.example.demo.DTO.ApiResponse;
import lombok.extern.slf4j.Slf4j;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

import java.util.stream.Collectors;

@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {

    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ApiResponse<String> handleValid(MethodArgumentNotValidException e){
        String msg = e.getBindingResult().getFieldErrors().stream()
                .map(f -> f.getField() + ":" + f.getDefaultMessage())
                .collect(Collectors.joining(", "));
        log.warn("参数校验异常: {}", msg);
        return ApiResponse.fail(400, msg);
    }

    @ExceptionHandler(BusinessException.class)
    public ApiResponse<String> handleBusiness(BusinessException e){
        log.warn("业务异常: code={}, message={}", e.getCode(), e.getMessage());
        return ApiResponse.fail(e.getCode(), e.getMessage());
    }

    @ExceptionHandler(RuntimeException.class)
    public ApiResponse<String> handleRuntime(RuntimeException e){
        log.error("运行时异常: ", e);
        return ApiResponse.fail(500, "服务器内部错误");
    }

    @ExceptionHandler(Exception.class)
    public ApiResponse<String> handleException(Exception e){
        log.error("未知异常: ", e);
        return ApiResponse.fail(500, "未知错误");
    }
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Component\CoTurnProperties.java ====
package com.example.demo.Component;

import lombok.Data;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.stereotype.Component;

@ConfigurationProperties(prefix = "coturn")
@Component
@Data
public class CoTurnProperties {
    private String host;
    private String secretKey;
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Component\DBMProducer.java ====
package com.example.demo.Component;

import com.example.demo.Config.RabbitConfig;
import com.example.demo.Entity.Message;
import com.example.demo.Entity.Storage;
import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.springframework.amqp.rabbit.core.RabbitTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;
import lombok.extern.slf4j.Slf4j;

@Component
@Slf4j
public class DBMProducer {

    @Autowired
    private RabbitTemplate rabbitTemplate;

    @Autowired
    private ObjectMapper objectMapper;

    //发送message
    public void sendDBMessage(Message message) {
        try {
            String json = objectMapper.writeValueAsString(message);
            rabbitTemplate.convertAndSend(
                    RabbitConfig.DB_EXCHANGE,
                    RabbitConfig.DB_MESSAGE_KEY,
                    json
            );
        }catch (JsonProcessingException e){
            log.error("sendDBMessage(Message) serialization failed: {}", e.getMessage());
        }
    }

    //发送storage
    public void sendDBMessage(Storage storage) {
        try {
            String json = objectMapper.writeValueAsString(storage);
            rabbitTemplate.convertAndSend(
                    RabbitConfig.DB_EXCHANGE,
                    RabbitConfig.DB_STORAGE_KEY,
                    json
            );
        }catch (JsonProcessingException e){
            log.error("sendDBMessage(Storage) serialization failed: {}", e.getMessage());
        }
    }

}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Component\DBWorker.java ====
package com.example.demo.Component;

import com.example.demo.Config.RabbitConfig;
import com.example.demo.Entity.Message;
import com.example.demo.Entity.Storage;
import com.example.demo.Repository.MessageRepository;
import com.example.demo.Repository.StorageRepository;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.rabbitmq.client.Channel;
import jakarta.annotation.PostConstruct;
import lombok.extern.slf4j.Slf4j;
import org.springframework.amqp.rabbit.annotation.RabbitListener;
import org.springframework.amqp.support.AmqpHeaders;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.core.task.TaskExecutor;
import org.springframework.messaging.handler.annotation.Header;
import org.springframework.stereotype.Component;

import java.io.IOException;
import java.time.Instant;
import java.util.ArrayList;
import java.util.List;
import java.util.concurrent.CompletableFuture;

@Component
@Slf4j
public class DBWorker {
    @Autowired
    private MessageRepository messageRepository;
    @Autowired
    private StorageRepository storageRepository;
    @Autowired
    private ObjectMapper objectMapper;
    @Autowired
    private TaskExecutor taskExecutor;

    // ----------- 配置参数 ------------
    private final int BATCH_SIZE = 50;           // 阈值
    private final long MAX_WAIT_MS = 100;        // 超时写入，ms
    private final Object lock = new Object();    // buffer 锁

    private final List<Message> buffer = new ArrayList<>();
    private Instant lastFlushTime = Instant.now();

    // ----------- 定时器检查 buffer 超时 ------------
    @PostConstruct
    public void startFlushTimer() {
        Thread t = new Thread(() -> {
            while (true) {
                try {
                    Thread.sleep(20); // 每 20ms 检查一次
                    flushIfTimeout();
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                    break;
                }
            }
        }, "BufferFlushTimer");
        t.setDaemon(true);
        t.start();
    }

    private void flushIfTimeout() {
        synchronized (lock) {
            if (buffer.isEmpty()) return;
            long elapsed = Instant.now().toEpochMilli() - lastFlushTime.toEpochMilli();
            if (elapsed >= MAX_WAIT_MS) {
                List<Message> toWrite = new ArrayList<>(buffer);
                buffer.clear();
                lastFlushTime = Instant.now();
                asyncInsertMessages(toWrite, null, 0); // null channel 表示超时 flush，不 ack
            }
        }
    }

    // ----------- 异步批量写 DB ------------
    private void asyncInsertMessages(List<Message> messages, Channel channel, long tag) {
        CompletableFuture.runAsync(() -> {
            try {
                messageRepository.insertBatch(messages); // 批量写 DB
                log.info("Batch insert {} messages", messages.size());

                // 如果 Listener 传了 channel → ack
                if (channel != null) {
                    try { channel.basicAck(tag, false); } catch (IOException e) { log.error("Failed to ack", e); }
                }
            } catch (Exception e) {
                log.error("Batch insert failed", e);
                if (channel != null) {
                    try { channel.basicNack(tag, false, true); } catch (IOException ex) { log.error("Failed to nack", ex); }
                }
            }
        }, taskExecutor);
    }


    // 异步写 Storage
    private void asyncInsertStorage(Storage storage, Channel channel, long tag) {
        CompletableFuture.runAsync(() -> {
            try {
                storageRepository.insertStorage(storage);
                channel.basicAck(tag, false);
                log.info("Storage saved async: {}", storage.getId());
            } catch (Exception e) {
                log.error("Failed to insert storage async: {}", storage, e);
                try {
                    channel.basicNack(tag, false, true);
                } catch (IOException ex) {
                    log.error("Failed to nack storage: {}", storage, ex);
                }
            }
        }, taskExecutor);
    }

    // ----------- Listener 收到消息 ------------
    @RabbitListener(queues = RabbitConfig.DB_MESSAGE_QUEUE)
    public void handleMessage(String json, Channel channel, @Header(AmqpHeaders.DELIVERY_TAG) long tag) {
        try {
            Message msg = objectMapper.readValue(json, Message.class);

            synchronized (lock) {
                buffer.add(msg);

                if (buffer.size() >= BATCH_SIZE) {
                    List<Message> toWrite = new ArrayList<>(buffer);
                    buffer.clear();
                    lastFlushTime = Instant.now();
                    asyncInsertMessages(toWrite, channel, tag);
                    return; // 阈值触发异步批量写入
                }
            }

            // 阈值没到，先 ack 保证消息不重发
            channel.basicAck(tag, false);

        } catch (Exception e) {
            log.error("Failed to deserialize message: {}", json, e);
            try { channel.basicNack(tag, false, true); } catch (IOException ex) { log.error("Failed to nack", ex); }
        }
    }


    @RabbitListener(queues = RabbitConfig.DB_STORAGE_QUEUE)
    public void handleStorage(String json, Channel channel, @Header(AmqpHeaders.DELIVERY_TAG) long tag) {
        try {
            Storage storage = objectMapper.readValue(json, Storage.class);
            asyncInsertStorage(storage, channel, tag);
        } catch (Exception e) {
            log.error("Failed to deserialize storage: {}", json, e);
            try {
                channel.basicNack(tag, false, true);
            } catch (IOException ex) {
                log.error("Failed to nack storage", ex);
            }
        }
    }
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Component\DefaultProperties.java ====
package com.example.demo.Component;


import lombok.Data;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.stereotype.Component;

@ConfigurationProperties(prefix = "default")
@Component
@Data
public class DefaultProperties {
    private String userAvatar;
    private String groupAvatar;
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Component\EmailSender.java ====
package com.example.demo.Component;


import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.mail.SimpleMailMessage;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Component;

@Component
public class EmailSender {

    @Autowired
    private JavaMailSender mailSender;

    @Value("${spring.mail.username}")
    private String IM_Mail;

    @Async("taskExecutor")
    public void sendEmail(String emailAddr, String info){
        SimpleMailMessage mailMessage = new SimpleMailMessage();
        mailMessage.setFrom(IM_Mail);
        mailMessage.setTo(emailAddr);
        mailMessage.setSubject("验证码");
        mailMessage.setText(info);

        mailSender.send(mailMessage);
    }
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Component\JwtAuthFilter.java ====
package com.example.demo.Component;

import io.jsonwebtoken.Claims;
import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

@RequiredArgsConstructor
@Component
@Slf4j
public class JwtAuthFilter extends OncePerRequestFilter {

    private final JwtService jwtService;

    @Override
    protected void doFilterInternal(HttpServletRequest request,
                                    HttpServletResponse response,
                                    FilterChain chain)
            throws ServletException, java.io.IOException {

        String authHeader = request.getHeader("Authorization");
        if (authHeader != null && authHeader.startsWith("Bearer ")) {
            String token = authHeader.substring(7);
            try {
                Claims claims = jwtService.parseToken(token);
                String userId = claims.getSubject();

                UsernamePasswordAuthenticationToken auth =
                        new UsernamePasswordAuthenticationToken(userId, null, null);

                SecurityContextHolder.getContext().setAuthentication(auth);
                log.debug("JWT authenticated userId={}", userId);

            } catch (Exception e) {
                log.warn("JWT parse failed: {}", e.getMessage());
                response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
                return;
            }
        }
        chain.doFilter(request, response);
    }
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Component\JwtProperties.java ====
package com.example.demo.Component;

import lombok.Data;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.stereotype.Component;

@Component
@ConfigurationProperties(prefix = "jwt")
@Data
public class JwtProperties {
    private String secretKey;
    private Integer accessExpireMinutes;
    private Integer refreshExpireDays;

}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Component\JwtService.java ====
package com.example.demo.Component;

import io.jsonwebtoken.Claims;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;
import io.jsonwebtoken.security.Keys;
import jakarta.annotation.PostConstruct;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.stereotype.Component;


import java.security.Key;
import java.time.Duration;
import java.util.Date;

@RequiredArgsConstructor
@Component
@Slf4j
public class JwtService {

    private final JwtProperties jwtProperties;


    private Key KEY;
    private long EXPIRATION_TIME;
    private long EXPIRATION_DAYS;

    @PostConstruct
    public void init(){
        this.KEY = Keys.hmacShaKeyFor(jwtProperties.getSecretKey().getBytes());
        Integer minutes = jwtProperties.getAccessExpireMinutes();
        Integer days = jwtProperties.getRefreshExpireDays();
        if (minutes == null || minutes <= 0) {
            minutes = 60;
        }
        this.EXPIRATION_TIME = Duration.ofMinutes(minutes).toMillis();
        this.EXPIRATION_DAYS = Duration.ofDays(days).toMillis();
        log.info("JWT initialized, expireMinutes={}, expirationMs={}", minutes, EXPIRATION_TIME);
    }

    public String generateAccessToken(Long userId, String account) {
        return Jwts.builder()
                .setSubject(String.valueOf(userId))
                .claim("account", account)
                .setIssuedAt(new Date())
                .setExpiration(new Date(System.currentTimeMillis() + EXPIRATION_TIME))
                .signWith(KEY, SignatureAlgorithm.HS256)
                .compact();
    }

    public String generateRefreshToken(Long userId){
        return Jwts.builder()
                .setSubject(String.valueOf(userId))
                .setIssuedAt(new Date())
                .setExpiration(new Date(System.currentTimeMillis() + EXPIRATION_DAYS))
                .signWith(KEY, SignatureAlgorithm.HS256)
                .compact();
    }

    public Claims parseToken(String token) {
        return Jwts.parserBuilder()
                .setSigningKey(KEY)
                .build()
                .parseClaimsJws(token)
                .getBody();
    }

    public String getUserId(String token) {
        return parseToken(token).getSubject();
    }
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Component\MinioProperties.java ====
package com.example.demo.Component;

import lombok.Data;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.stereotype.Component;

@ConfigurationProperties(prefix = "minio")
@Component
@Data
public class MinioProperties {
    private String endpoint;
    private String accessKey;
    private String secretKey;
    private String bucket;
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Component\MinioWorker.java ====
package com.example.demo.Component;


import com.example.demo.DTO.UploadInitResponse;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Component;
import org.springframework.web.multipart.MultipartFile;
import software.amazon.awssdk.auth.credentials.AwsBasicCredentials;
import software.amazon.awssdk.auth.credentials.StaticCredentialsProvider;
import software.amazon.awssdk.core.sync.RequestBody;
import software.amazon.awssdk.regions.Region;
import software.amazon.awssdk.services.s3.S3Client;
import software.amazon.awssdk.services.s3.model.*;
import software.amazon.awssdk.services.s3.presigner.S3Presigner;
import software.amazon.awssdk.services.s3.presigner.model.GetObjectPresignRequest;

import java.io.IOException;
import java.io.InputStream;
import java.net.URI;
import java.time.Duration;
import java.util.*;
import java.util.concurrent.*;
import java.util.stream.Collectors;

/**
 * MinioWorker - 使用 AWS S3 SDK (v2) 操作 MinIO/S3。
 *
 *
 * 分块数量： 1~totalParts
 *
 * Redis 数据：
 *  - upload:{uploadId}:meta  (hash) -> bucket, key, totalParts (可选)
 *  - upload:{uploadId}:bitmap (bitmap) -> 分块是否上传成功（bit 位从 1 开始）
 *  - upload:{uploadId}:etags (hash) -> field=partNumber, value=eTag
 */
@Component
@Slf4j
public class MinioWorker {

    private final S3Client s3Client;
    private final RedisTemplate<String, Object> redisTemplate;
    private final Duration redisTtl = Duration.ofDays(1); // TTL，用于过期回收

    public MinioWorker(S3Client s3Client, RedisTemplate<String, Object> redisTemplate) {
        this.s3Client = s3Client;
        this.redisTemplate = redisTemplate;
    }

    private String keyPrefix(String uploadId) {
        return "upload:" + uploadId;
    }


    //一次性上传
    public boolean easyUpload(String bucket, String key, MultipartFile file){
        PutObjectRequest putObjectRequest = PutObjectRequest.builder()
                .bucket(bucket)
                .key(key)
                .contentType(file.getContentType())
                .build();

        try {
            s3Client.putObject(
                    putObjectRequest,
                    RequestBody.fromInputStream(file.getInputStream(), file.getSize())
            );
            return true;
        }catch (IOException e){
            return false;
        }

    }



    //初始化 Multipart Upload
    //uploadIdKey : uploadId:{userId}:{filehash}
    public UploadInitResponse initUpload(String bucket, String key, Integer totalParts, String uploadIdKey) {
        UploadInitResponse uploadInitResponse = new UploadInitResponse();
        String existingUploadId = (String)redisTemplate.opsForValue().get(uploadIdKey);
        if(existingUploadId != null){
            uploadInitResponse.setUploadId(existingUploadId);
            uploadInitResponse.setNewCreated(false);
            log.info("initUpload reuse uploadId={}", existingUploadId);
            return uploadInitResponse;
        }
        CreateMultipartUploadResponse resp = s3Client.createMultipartUpload(
                CreateMultipartUploadRequest.builder()
                        .bucket(bucket)
                        .key(key) //account/uuid
                        .build()
        );
        String uploadId = resp.uploadId();

        String prefix = keyPrefix(uploadId);
        Map<String, String> meta = new HashMap<>();
        meta.put("bucket", bucket);
        meta.put("key", key);
        meta.put("uploadId", uploadId);
        if (totalParts != null) meta.put("totalParts", String.valueOf(totalParts));
        // 保存 meta , uploadId 到 redis
        redisTemplate.opsForHash().putAll(prefix + ":meta", meta);
        redisTemplate.expire(prefix + ":meta", redisTtl);
        redisTemplate.opsForValue().set(uploadIdKey,uploadId);
        redisTemplate.expire(uploadIdKey,redisTtl);

        uploadInitResponse.setUploadId(uploadId);
        uploadInitResponse.setNewCreated(true);
        log.info("initUpload new uploadId={} bucket={} key={}", uploadId, bucket, key);
        return uploadInitResponse;
    }

    //上传单个分块
    @Async("taskExecutor")
    public void uploadPart(String uploadId, Integer partNumber, InputStream inputStream,long size){
        String prefix = keyPrefix(uploadId);
        String bitmapKey = prefix + ":bitmap";
        String etagsKey = prefix + ":etags";
        // 已上传跳过（由 bitmap 控制）
        Boolean exists = redisTemplate.opsForValue().getBit(bitmapKey, partNumber);
        if (Boolean.TRUE.equals(exists)) {
            // 已上传，直接返回 null（调用方需过滤 null）
            return ;
        }
        // 读取 meta
        String bucket = (String) redisTemplate.opsForHash().get(prefix + ":meta", "bucket");
        String key = (String) redisTemplate.opsForHash().get(prefix + ":meta", "key");
        if (bucket == null || key == null) throw new IllegalStateException("upload meta missing for " + uploadId);
        try{
            UploadPartRequest uploadReq = UploadPartRequest.builder()
                    .bucket(bucket)
                    .key(key)
                    .uploadId(uploadId)
                    .partNumber(partNumber)
                    .contentLength(size)
                    .build();

            UploadPartResponse uploadResp = s3Client.uploadPart(uploadReq, RequestBody.fromInputStream(inputStream,size));
            String etag = uploadResp.eTag();
            // 存 Redis: bitmap + etag
            redisTemplate.opsForValue().setBit(bitmapKey, partNumber, true);
            redisTemplate.opsForHash().put(etagsKey, String.valueOf(partNumber), etag);
            redisTemplate.expire(bitmapKey, redisTtl);
            redisTemplate.expire(etagsKey, redisTtl);
            log.info("uploadPart uploadId={} partNumber={} etag={}", uploadId, partNumber, etag);

        }catch (Exception ex) {
            throw new CompletionException(ex);
        }
    }


    //合并分块（从 Redis 读取 etags）,说明：parts 必须按 partNumber 升序
    public boolean completeUpload(String uploadId) {
        String prefix = keyPrefix(uploadId);
        Map<Object, Object> etags = redisTemplate.opsForHash().entries(prefix + ":etags");
        if (etags == null || etags.isEmpty()) {
            throw new IllegalStateException("No parts found in redis for uploadId=" + uploadId);
        }

        List<CompletedPart> parts = etags.entrySet().stream()
                .map(e -> CompletedPart.builder()
                        .partNumber(Integer.parseInt((String) e.getKey()))
                        .eTag((String) e.getValue())
                        .build())
                .sorted(Comparator.comparingInt(CompletedPart::partNumber))
                .collect(Collectors.toList());

        String bucket = (String) redisTemplate.opsForHash().get(prefix + ":meta", "bucket");
        String key = (String) redisTemplate.opsForHash().get(prefix + ":meta", "key");

        CompletedMultipartUpload completed = CompletedMultipartUpload.builder()
                .parts(parts)
                .build();

        CompleteMultipartUploadRequest compReq = CompleteMultipartUploadRequest.builder()
                .bucket(bucket)
                .key(key)
                .uploadId(uploadId)
                .multipartUpload(completed)
                .build();

        CompleteMultipartUploadResponse response = s3Client.completeMultipartUpload(compReq);
        // 清理 redis
        redisTemplate.delete(Arrays.asList(prefix + ":meta", prefix + ":bitmap", prefix + ":etags"));
        log.info("completeUpload uploadId={} success={}", uploadId, response.sdkHttpResponse().isSuccessful());
        return response.sdkHttpResponse().isSuccessful();

    }


    //列出未上传分片
    public List<Integer> getMissingParts(String uploadId) {
        String prefix = keyPrefix(uploadId);
        String bitmapKey = prefix+":bitmap";
        List<Integer>missing = new ArrayList<>();
        String totalPartsStr = (String) redisTemplate.opsForHash().get(prefix + ":meta", "totalParts");
        int totalParts = 0;
        if (totalPartsStr != null) {
            totalParts = Integer.parseInt(totalPartsStr);
            for(int i = 1; i<=totalParts;i++){
                Boolean uploaded = redisTemplate.opsForValue().getBit(bitmapKey,i);
                if(!Boolean.TRUE.equals(uploaded)){
                    missing.add(i);
                }
            }
        }
        return missing;

    }


    // 中止上传
    public void abortUpload(String uploadId) {
        String prefix = keyPrefix(uploadId);
        String bucket = (String) redisTemplate.opsForHash().get(prefix + ":meta", "bucket");
        String key = (String) redisTemplate.opsForHash().get(prefix + ":meta", "key");
        String uploadIdFromMeta = (String) redisTemplate.opsForHash().get(prefix + ":meta", "uploadId");

        if (bucket == null || key == null || uploadIdFromMeta == null) return;

        s3Client.abortMultipartUpload(AbortMultipartUploadRequest.builder()
                .bucket(bucket)
                .key(key)
                .uploadId(uploadIdFromMeta)
                .build());

        redisTemplate.delete(Arrays.asList(prefix + ":meta", prefix + ":bitmap", prefix + ":etags"));
    }


    public String getUrl(String bucket, String key,String endpoint,String accessKey,String secretKey) {
        try (S3Presigner presigner = S3Presigner.builder()
                .endpointOverride(URI.create(endpoint))
                .credentialsProvider(StaticCredentialsProvider.create(
                        AwsBasicCredentials.create(accessKey, secretKey)
                ))
                .region(Region.US_EAST_1)
                .build()) {

            GetObjectPresignRequest presignRequest =
                    GetObjectPresignRequest.builder()
                            .signatureDuration(Duration.ofHours(12))
                            .getObjectRequest(
                                    GetObjectRequest.builder()
                                            .bucket(bucket)
                                            .key(key)
                                            .build()
                            )
                            .build();

            String url = presigner.presignGetObject(presignRequest).url().toString();
            log.info("getUrl bucket={} key={} url={}", bucket, key, url);
            return url;
        }
    }

    public String getUploadIdByKey(String uploadIdKey) {
        Object v = redisTemplate.opsForValue().get(uploadIdKey);
        return v == null ? null : (String) v;
    }




}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Component\RateLimitProperties.java ====
package com.example.demo.Component;

import lombok.Data;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.stereotype.Component;

@ConfigurationProperties(prefix = "limit")
@Component
@Data
public class RateLimitProperties {
    private int avatarDailyLimit = 3;
    private int nicknameCooldownMinutes = 10;
    private int signatureCooldownMinutes = 1;
    private int applicationDailyLimit = 100;
    private int createGroupDailyLimit = 20;
    private int messagePerMinuteLimit = 100;
    private int uploadDailyLimit = 100;
    private int passwordResetDailyLimit = 5;
}



==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Component\ReadRecordFlushScheduler.java ====
package com.example.demo.Component;


import com.example.demo.Service.ReadRecordService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;
import org.springframework.data.redis.core.ScanOptions;
import org.springframework.data.redis.core.Cursor;

@Component
@RequiredArgsConstructor
@Slf4j
public class ReadRecordFlushScheduler {

    private final StringRedisTemplate redisTemplate;
    private final ReadRecordService readRecordService;

    private static final String ONLINE_PREFIX = "user:online:";

    /**
     * 每3秒扫描在线用户并刷脏数据到DB
     */
    @Scheduled(fixedDelay = 3000)
    public void scheduledFlush() {
        try {
            scanOnlineAndFlush();
        } catch (Exception e) {
            log.error("scheduledFlush error", e);
        }
    }

    private void scanOnlineAndFlush() {
        Cursor<byte[]> cursor = null;
        int flushCount = 0;

        try {
            cursor = redisTemplate.getConnectionFactory()
                    .getConnection()
                    .scan(ScanOptions.scanOptions()
                            .match(ONLINE_PREFIX + "*")
                            .count(200)
                            .build());

            while (cursor.hasNext()) {
                String key = new String(cursor.next());
                Long userId = parseUserId(key);
                if (userId == null) {
                    continue;
                }

                try {
                    readRecordService.flushReadRecordToDB(userId);
                    flushCount++;
                } catch (Exception e) {
                    log.error("flush userId={} failed", userId, e);
                }
            }

        } finally {
            if (cursor != null) try { cursor.close(); } catch (Exception ignore) {}
        }

        if (flushCount > 0) {
            log.info("定时刷新已读记录, 在线用户数={} flushUsers={}", flushCount, flushCount);
        }
    }

    private Long parseUserId(String key) {
        if (!key.startsWith(ONLINE_PREFIX)) return null;
        try {
            return Long.valueOf(key.substring(ONLINE_PREFIX.length()));
        } catch (Exception e) {
            return null;
        }
    }
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Component\RedissonProperties.java ====
package com.example.demo.Component;


import lombok.Data;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.stereotype.Component;

@Data
@Component
@ConfigurationProperties(prefix = "redisson")
public class RedissonProperties {
    private String host;
    private int port;
    private int database;
    private String password;
    private int timeout;
}

==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Component\SnowflakeIdUtils.java ====
package com.example.demo.Component;



public class SnowflakeIdUtils {

    // ============================== Fields ==============================
    // 开始时间戳 (可自定义，比如项目上线日期，减少位数)
    private static final long START_STAMP = 1609459200000L; // 2021-01-01

    private static final long DATA_CENTER_BIT = 5;  // 数据中心位数
    private static final long MACHINE_BIT = 5;      // 机器标识位数
    private static final long SEQUENCE_BIT = 12;    // 序列号位数（每毫秒 4096）

    private static final long MAX_DATA_CENTER_NUM = ~(-1L << DATA_CENTER_BIT);
    private static final long MAX_MACHINE_NUM = ~(-1L << MACHINE_BIT);
    private static final long MAX_SEQUENCE = ~(-1L << SEQUENCE_BIT);

    private static final long MACHINE_LEFT = SEQUENCE_BIT;
    private static final long DATA_CENTER_LEFT = SEQUENCE_BIT + MACHINE_BIT;
    private static final long TIMESTAMP_LEFT = DATA_CENTER_LEFT + DATA_CENTER_BIT;

    private long dataCenterId;
    private long machineId;
    private long sequence = 0L;
    private long lastStamp = -1L;

    // ============================== Constructor ==============================
    public SnowflakeIdUtils(long dataCenterId, long machineId) {
        if (dataCenterId > MAX_DATA_CENTER_NUM || dataCenterId < 0) {
            throw new IllegalArgumentException("dataCenterId 超出范围");
        }
        if (machineId > MAX_MACHINE_NUM || machineId < 0) {
            throw new IllegalArgumentException("machineId 超出范围");
        }
        this.dataCenterId = dataCenterId;
        this.machineId = machineId;
    }

    // ============================== Core Method ==============================
    public synchronized long nextId() {
        long currStamp = System.currentTimeMillis();
        if (currStamp < lastStamp) {
            throw new RuntimeException("系统时钟倒退，生成ID失败");
        }

        if (currStamp == lastStamp) {
            sequence = (sequence + 1) & MAX_SEQUENCE;
            if (sequence == 0) {
                currStamp = getNextMill();
            }
        } else {
            sequence = 0L;
        }

        lastStamp = currStamp;

        return (currStamp - START_STAMP) << TIMESTAMP_LEFT
                | (dataCenterId << DATA_CENTER_LEFT)
                | (machineId << MACHINE_LEFT)
                | sequence;
    }

    private long getNextMill() {
        long mill = System.currentTimeMillis();
        while (mill <= lastStamp) {
            mill = System.currentTimeMillis();
        }
        return mill;
    }
}

==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Component\TurnTokenUtil.java ====
package com.example.demo.Component;


import com.example.demo.DTO.IceServer;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Component;

import java.security.InvalidKeyException;
import java.security.NoSuchAlgorithmException;
import java.time.Instant;
import javax.crypto.Mac;
import javax.crypto.spec.SecretKeySpec;
import java.util.Base64;
import java.util.List;

@Component
@RequiredArgsConstructor
public class TurnTokenUtil {



    private final CoTurnProperties coTurnProperties; // static-auth-secret
    private static final long TTL = 600; // 秒，凭证有效期


    public IceServer generateCredential() {
        long timestamp = Instant.now().getEpochSecond() + TTL;
        String username = Long.toString(timestamp);

        try {
            Mac mac = Mac.getInstance("HmacSHA1");
            mac.init(new SecretKeySpec(coTurnProperties.getSecretKey().getBytes(), "HmacSHA1"));
            byte[] rawHmac = mac.doFinal(username.getBytes());
            String password = Base64.getEncoder().encodeToString(rawHmac);

            List<String> urls = List.of(
                    "stun:"+coTurnProperties.getHost(),
                    "turn:"+coTurnProperties.getHost()+"?transport=udp",
                    "turn:"+coTurnProperties.getHost()+"?transport=tcp"
            );
            return new IceServer(urls,username, password);
        }catch (NoSuchAlgorithmException e){
            e.printStackTrace();
            return null;
        } catch (InvalidKeyException e) {
            throw new RuntimeException(e);
        }
    }



}

==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Component\UserHandshakeHandler.java ====
package com.example.demo.Component;




import com.example.demo.DTO.UserPrincipal;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.http.server.ServerHttpRequest;
import org.springframework.stereotype.Component;
import org.springframework.web.socket.WebSocketHandler;
import org.springframework.web.socket.server.support.DefaultHandshakeHandler;
import java.security.Principal;
import java.util.Map;

@Component
@Slf4j
public class UserHandshakeHandler extends DefaultHandshakeHandler {
    @Autowired
    private StringRedisTemplate redisTemplate;
    @Override
    protected Principal determineUser(ServerHttpRequest request, WebSocketHandler wsHandler, Map<String, Object> attributes) {
        String uuid = (String) attributes.get("uuid");
        String userId = (String) attributes.get("userId");
        String principalName = uuid != null ? uuid : userId;
        log.info("WS principal bound principalName={}, userId={}", principalName, userId);
        return new UserPrincipal(principalName);
    }
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Component\WebSocketEventListener.java ====
package com.example.demo.Component;


import com.example.demo.Service.ReadRecordService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.context.event.EventListener;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.messaging.simp.stomp.StompHeaderAccessor;
import org.springframework.stereotype.Component;
import org.springframework.web.socket.messaging.SessionConnectEvent;
import org.springframework.web.socket.messaging.SessionDisconnectEvent;

import java.util.Map;
import java.util.concurrent.TimeUnit;

@Slf4j
@Component
@RequiredArgsConstructor
public class WebSocketEventListener {

    private final StringRedisTemplate redis;
    private final JwtService jwtService;
    private final ReadRecordService readRecordService;

    //处理连接事件
    @EventListener
    public void handleConnectEvent(SessionConnectEvent event) {
        log.info("1");
        StompHeaderAccessor accessor = StompHeaderAccessor.wrap(event.getMessage());

        // 1. 解析 Token 获取 UserId
        String token = accessor.getFirstNativeHeader("Authorization");
        String userId = null;

        if (token != null && token.startsWith("Bearer ")) {
            token = token.substring(7);
            try {
                userId = jwtService.getUserId(token);
            } catch (Exception e) {
                log.error("WebSocket连接鉴权失败: {}", e.getMessage());
                return; // 或者抛出异常断开连接
            }
        }

        if (userId != null) {
            log.info("{}",userId);
            // 2. 关键步骤：将 userId 放入 Session 属性中，以便断开连接时使用
            Map<String, Object> sessionAttributes = accessor.getSessionAttributes();
            if (sessionAttributes != null) {
                sessionAttributes.put("userId", userId);
            }

            // 3. Redis 操作：设备数 +1
            String connKey = "user:conn:" + userId;
            redis.opsForValue().increment(connKey);

            readRecordService.cacheUserReadRecords(Long.valueOf(userId));


            // 4. Redis 操作：标记在线
            // 注意：这里设置了过期时间，建议配合心跳机制续期，否则300s后用户还在连接但Redis key没了
            redis.opsForValue().set("user:online:" + userId, "1", 300, TimeUnit.SECONDS);

            log.info("User {} connected. Device count incremented.", userId);
        }
    }


    //处理断开连接事件
    @EventListener
    public void handleDisconnectEvent(SessionDisconnectEvent event) {
        StompHeaderAccessor accessor = StompHeaderAccessor.wrap(event.getMessage());

        // 1. 从 Session 属性中直接获取 UserId (不需要重新解析 Token)
        Map<String, Object> sessionAttributes = accessor.getSessionAttributes();
        String userId = (sessionAttributes != null) ? (String) sessionAttributes.get("userId") : null;

        if (userId != null) {
            String connKey = "user:conn:" + userId;
            String onlineKey = "user:online:" + userId;

            // 2. Redis 操作：设备数 -1
            Long currentCount = redis.opsForValue().decrement(connKey);

            // 3. 判断是否需要移除在线状态
            // 如果 currentCount 为 null 或者 <= 0，说明这是最后一个设备断开
            if (currentCount == null || currentCount <= 0) {
                readRecordService.flushReadRecordToDB(Long.valueOf(userId));
                redis.delete(onlineKey);
                redis.delete(connKey);

                log.info("User {} 下线. All devices offline.", userId);
            } else {
                log.info("User {} device disconnected. Remaining devices: {}", userId, currentCount);
            }
        }
    }
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Config\AsyncConfig.java ====
package com.example.demo.Config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.task.TaskExecutor;
import org.springframework.scheduling.annotation.EnableAsync;
import org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;

import java.util.concurrent.Executor;

@Configuration
@EnableAsync
public class AsyncConfig {

    @Bean(name = "taskExecutor")
    public TaskExecutor taskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(4);
        executor.setMaxPoolSize(8);
        executor.setQueueCapacity(100);
        executor.setThreadNamePrefix("my-task-");
        executor.initialize();
        return executor;
    }
}

==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Config\CorsConfig.java ====
package com.example.demo.Config;

import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.CorsRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class CorsConfig implements WebMvcConfigurer{
    @Override
    public void addCorsMappings(CorsRegistry registry){
        registry.addMapping("/**")
                .allowedOriginPatterns("*")
                .allowedMethods("*")
                .allowedHeaders("*")
                .allowCredentials(true);
    }
}



==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Config\IdGeneratorConfig.java ====
package com.example.demo.Config;


import com.example.demo.Component.SnowflakeIdUtils;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class IdGeneratorConfig {

    @Bean
    public SnowflakeIdUtils idGenerator() {
        return new SnowflakeIdUtils(1, 1); // 数据中心1，机器1
    }
}
//long uid = idGenerator.nextId();

==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Config\JacksonConfig.java ====
package com.example.demo.Config;


import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.module.SimpleModule;
import com.fasterxml.jackson.databind.ser.std.ToStringSerializer;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class JacksonConfig {
    @Bean
    public ObjectMapper objectMapper() {
        ObjectMapper mapper = new ObjectMapper();
        SimpleModule module = new SimpleModule();
        module.addSerializer(Long.class, ToStringSerializer.instance);
        module.addSerializer(Long.TYPE, ToStringSerializer.instance); // long 基本类型
        mapper.registerModule(module);
        return mapper;
    }
}

==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Config\OpenAPIConfig.java ====
package com.example.demo.Config;


import io.swagger.v3.oas.models.info.Info;
import io.swagger.v3.oas.models.OpenAPI;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class OpenAPIConfig {

    @Bean
    public OpenAPI customOpenAPI() {
        return new OpenAPI()
                .info(new Info()
                        .title("My API Documentation")
                        .version("1.0")
                        .description("这是你的项目的 API 文档"));
    }
}

==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Config\RabbitConfig.java ====
package com.example.demo.Config;


import org.springframework.amqp.core.*;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class RabbitConfig {

    // 交换机名称
    public static final String DB_EXCHANGE = "db_exchange";

    // 队列名称
    public static final String DB_MESSAGE_QUEUE = "db_message_queue";
    public static final String DB_STORAGE_QUEUE = "db_storage_queue";


    // 路由键
    public static final String DB_MESSAGE_KEY = "db.message";
    public static final String DB_STORAGE_KEY = "db.storage";


    //定义 Direct Exchange

    @Bean
    public DirectExchange dbExchange() {
        return new DirectExchange(DB_EXCHANGE, true, false);
    }


     //队列

    @Bean
    public Queue dbMessageQueue() {
        return QueueBuilder.durable(DB_MESSAGE_QUEUE)
                .build();
    }

    @Bean
    public Queue dbStorageQueue() {
        return QueueBuilder.durable(DB_STORAGE_QUEUE)
                .build();
    }



    //队列绑定

    @Bean
    public Binding meaasgeBinding(DirectExchange dbExchange, Queue dbMessageQueue) {
        return BindingBuilder.bind(dbMessageQueue).to(dbExchange).with(DB_MESSAGE_KEY);
    }

    @Bean
    public Binding storageBinding(DirectExchange dbExchange, Queue dbStorageQueue) {
        return BindingBuilder.bind(dbStorageQueue).to(dbExchange).with(DB_STORAGE_KEY);
    }



}

==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Config\RedisConfig.java ====
package com.example.demo.Config;


import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.redis.connection.RedisConnectionFactory;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.data.redis.serializer.GenericJackson2JsonRedisSerializer;
import org.springframework.data.redis.serializer.StringRedisSerializer;

@Configuration
public class RedisConfig {

    @Bean
    public StringRedisTemplate stringRedisTemplate(RedisConnectionFactory factory) {
        return new StringRedisTemplate(factory);
    }

    @Bean
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory factory) {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(factory);

        StringRedisSerializer stringSerializer = new StringRedisSerializer();
        GenericJackson2JsonRedisSerializer jsonSerializer = new GenericJackson2JsonRedisSerializer();

        template.setKeySerializer(stringSerializer);
        template.setHashKeySerializer(stringSerializer);
        template.setValueSerializer(jsonSerializer);
        template.setHashValueSerializer(jsonSerializer);

        template.afterPropertiesSet();
        return template;
    }
}

==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Config\RedissonConfig.java ====
package com.example.demo.Config;

import com.example.demo.Component.RedissonProperties;
import org.springframework.context.annotation.Configuration;

import org.redisson.Redisson;
import org.redisson.api.RedissonClient;
import org.redisson.config.Config;
import org.springframework.context.annotation.Bean;

@Configuration
public class RedissonConfig {

    @Bean
    public RedissonClient redissonClient(RedissonProperties properties) {

        Config config = new Config();

        config.useSingleServer()
                .setAddress("redis://" + properties.getHost() + ":" + properties.getPort())
                .setPassword(properties.getPassword())
                .setDatabase(properties.getDatabase())
                .setTimeout(properties.getTimeout());

        return Redisson.create(config);
    }
}

==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Config\S3Config.java ====
package com.example.demo.Config;

import com.example.demo.Component.MinioProperties;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import software.amazon.awssdk.auth.credentials.AwsBasicCredentials;
import software.amazon.awssdk.auth.credentials.StaticCredentialsProvider;
import software.amazon.awssdk.regions.Region;
import software.amazon.awssdk.services.s3.S3Client;
import software.amazon.awssdk.services.s3.S3Configuration;

import java.net.URI;

@Configuration
public class S3Config {
    @Autowired
    private MinioProperties minioProperties;


    @Bean(destroyMethod = "close")
    public S3Client s3Client() {
        return S3Client.builder()
                .endpointOverride(URI.create(minioProperties.getEndpoint()))
                .credentialsProvider(StaticCredentialsProvider.create(
                        AwsBasicCredentials.create(minioProperties.getAccessKey(), minioProperties.getSecretKey())))
                .region(Region.US_EAST_1) // region 对 MinIO 无实际意义，随意设置
                .serviceConfiguration(S3Configuration.builder()
                        .pathStyleAccessEnabled(true) // MinIO 需要 path 风格
                        .build())
                .build();
    }
}

==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Config\ScheduleConfig.java ====
package com.example.demo.Config;


import org.springframework.context.annotation.Configuration;
import org.springframework.scheduling.annotation.EnableScheduling;

@Configuration
@EnableScheduling
public class ScheduleConfig {
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Config\SecurityConfig.java ====
package com.example.demo.Config;



import com.example.demo.Component.JwtAuthFilter;
import lombok.RequiredArgsConstructor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;
import org.springframework.web.cors.CorsConfiguration;

@RequiredArgsConstructor
@Configuration
public class SecurityConfig {

    private final JwtAuthFilter jwtFilter;



    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http.csrf(csrf -> csrf.disable());

        http.cors(cors -> cors.configurationSource(request -> {
            CorsConfiguration config = new CorsConfiguration();
            config.setAllowCredentials(true);
            config.addAllowedOriginPattern("*"); // ✅ 配 patterns
            config.addAllowedHeader("*");
            config.addAllowedMethod("*");
            return config;
        }));

        http.sessionManagement(session -> session.sessionCreationPolicy(SessionCreationPolicy.STATELESS));

        http.authorizeHttpRequests(auth -> auth
                .requestMatchers(
                        "/auth/login",
                        "/auth/beforeRegister",
                        "/auth/register",
                        "/auth/refresh",
                        "/ws/**"   // ✅ WebSocket 握手放行
                ).permitAll()
                .anyRequest().authenticated()
        );

        http.addFilterBefore(jwtFilter, UsernamePasswordAuthenticationFilter.class);

        return http.build();
    }
}

==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Config\WebSocketConfig.java ====
package com.example.demo.Config;



import com.example.demo.Component.UserHandshakeHandler;
import com.example.demo.Interceptor.AuthHandshakeInterceptor;
import lombok.RequiredArgsConstructor;
import org.springframework.context.annotation.Configuration;
import org.springframework.messaging.simp.config.MessageBrokerRegistry;
import org.springframework.web.socket.config.annotation.EnableWebSocketMessageBroker;
import org.springframework.web.socket.config.annotation.StompEndpointRegistry;
import org.springframework.web.socket.config.annotation.WebSocketMessageBrokerConfigurer;
import org.springframework.web.socket.config.annotation.WebSocketTransportRegistration;

@Configuration
@EnableWebSocketMessageBroker
@RequiredArgsConstructor
public class WebSocketConfig implements WebSocketMessageBrokerConfigurer {
    private final AuthHandshakeInterceptor authHandshakeInterceptor;
    private final UserHandshakeHandler userHandshakeHandler;

    @Override
    public void registerStompEndpoints(StompEndpointRegistry registry) {
        registry.addEndpoint("/ws")
                .addInterceptors(authHandshakeInterceptor)
                .setHandshakeHandler(userHandshakeHandler)
                .setAllowedOriginPatterns("*");
    }

    @Override
    public void configureMessageBroker(MessageBrokerRegistry registry) {
        // 前缀 /app 代表客户端发送的消息走 @MessageMapping 方法
        registry.setApplicationDestinationPrefixes("/app");

        // 启用内置的简单消息代理，前缀 /user 表示点对点消息
        registry.enableSimpleBroker("/topic","/queue");
        registry.setUserDestinationPrefix("/user");
    }


    @Override
    public void configureWebSocketTransport(WebSocketTransportRegistration registry) {
        registry.setSendTimeLimit(15 * 1000)
                .setSendBufferSizeLimit(512 * 1024)
                .setTimeToFirstMessage(10 * 1000);
    }
}

==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Controller\ApplicationController.java ====
package com.example.demo.Controller;

import com.example.demo.AOP.LimitApplication;
import com.example.demo.DTO.ApiResponse;
import com.example.demo.DTO.ApplicationReq;
import com.example.demo.Entity.Application;
import com.example.demo.Service.ApplicationService;
import com.example.demo.Tools.AuthUtil;
import io.swagger.v3.oas.annotations.Operation;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Objects;

@RestController
@RequestMapping("/application")
@RequiredArgsConstructor
@Slf4j
public class ApplicationController {

    private final ApplicationService applicationService;

    @LimitApplication
    @Operation(summary = "",description = "")
    @PostMapping("/sendApplication")
    public ApiResponse<String> sendApplication(@RequestBody @Valid ApplicationReq applicationReq){

        String userId = AuthUtil.getUserId();
        if(Objects.equals(applicationReq.getTo(), Long.valueOf(userId))){
            log.warn("自己不能给自己发送申请！");
            return ApiResponse.fail("invalid");
        }

        applicationReq.setFrom(userId);

        return applicationService.operateApplication(applicationReq);

    }

    @Operation(summary = "",description = "")
    @PostMapping("/read")
    public void readApplication(@RequestParam("applicationId")String applicationId){
        Long userId = Long.valueOf(AuthUtil.getUserId());
        applicationService.readApplication(userId,Long.valueOf(applicationId));
    }


    @Operation(summary = "",description = "")
    @PostMapping("/resp")
    public void respApplication(@RequestParam("applicationId")String applicationId,
                                               @RequestParam("result")String result){
        Long userId = Long.valueOf(AuthUtil.getUserId());
        applicationService.respApplication(Long.valueOf(applicationId),userId,result);
    }

    @RequestMapping("/getSent")
    public ApiResponse<List<Application>>getSentApplication(){
        Long userId = Long.valueOf(AuthUtil.getUserId());
        List<Application>applications = applicationService.getSentApplication(userId);
        return ApiResponse.success(applications);
    }

    @RequestMapping("/getReceive")
    public ApiResponse<List<Application>>getReceiveApplication(){
        Long userId = Long.valueOf(AuthUtil.getUserId());
        List<Application>applications = applicationService.getReceiveApplication(userId);
        return ApiResponse.success(applications);
    }



}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Controller\AuthController.java ====
package com.example.demo.Controller;



import com.example.demo.AOP.LimitPWReset;
import com.example.demo.Component.JwtService;
import com.example.demo.DTO.ApiResponse;
import com.example.demo.DTO.LocalSeq;
import com.example.demo.DTO.LoginRequest;

import com.example.demo.DTO.TokenResp;
import com.example.demo.Service.LoginService;
import com.example.demo.Service.RegisterService;
import com.example.demo.Service.TokenService;
import com.example.demo.Tools.AuthUtil;
import io.jsonwebtoken.Claims;
import io.jsonwebtoken.ExpiredJwtException;
import io.jsonwebtoken.Jwts;
import io.swagger.v3.oas.annotations.Operation;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.security.core.parameters.P;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;
import jakarta.validation.constraints.Size;
import jakarta.validation.constraints.NotBlank;
import java.util.List;
import java.util.Map;


@Slf4j
@RequiredArgsConstructor
@RestController
@Validated
@RequestMapping("/auth")
public class AuthController {


    private final LoginService loginService;
    private final RegisterService registerService;
    private final JwtService jwtService;
    private final TokenService tokenService;


    @PostMapping("/refresh")
    public ApiResponse<String> refresh(@RequestParam("refreshToken")String refreshToken) {


        try {

            Map<Object,Object> userMap = tokenService.getRefreshToken(refreshToken);
            if (userMap == null) {
                return ApiResponse.invalid("Invalid refresh token");
            }

            String userId = userMap.get("userId").toString();
            String account = userMap.get("account").toString();
            log.info("{}   {}",userId,account);
            // 生成新的 access token
            String newAccessToken = jwtService.generateAccessToken(Long.valueOf(userId),account);

            return ApiResponse.success(newAccessToken);
        } catch (ExpiredJwtException e) {
            return ApiResponse.invalid("Refresh token expired, please login again");
        }
    }


    @PostMapping("/beforeLoginByEmail")
    public ApiResponse<String> beforeLoginByEmail(@RequestParam("email_addr")String email_addr){
        String uuid = loginService.beforeLoginByEmail(email_addr);
        return ApiResponse.success(uuid);

    }

    @Operation(summary = "",description = "")
    @PostMapping("/login")
    public ApiResponse<TokenResp> login(@RequestBody LoginRequest req) {
        TokenResp tokenResp = loginService.login(req);

        if ( tokenResp!=null) {
            log.info("登录成功！ token：{}",tokenResp);
            return ApiResponse.success(tokenResp);
        } else {
            return ApiResponse.fail("Invalid credentials");
        }
    }

    @Operation(summary = "",description = "")
    @PostMapping("/beforeRegister")
    public ApiResponse<String> beforeRegister(@RequestParam("emailAddr")String emailAddr){
        log.info("email地址为 ：{}的用户尝试注册账号",emailAddr);
        String result = registerService.sendEmail(emailAddr);
        if(result == null || result.isEmpty()){
            log.error("未成功返回uuid");
            return ApiResponse.fail("please try later");
        }else{
            log.info("成功返回uuid，uuid为{}",result);
            return ApiResponse.success(result);
        }
    }

    @Operation(summary = "",description = "")
    @PostMapping("/register")
    public ApiResponse<String> register(@RequestParam("uuid")String uuid,
                                   @RequestParam("code")String code,
                                   @RequestParam("emailAddr")String emailAddr,
                                   @RequestParam("name")
                                   @Size(max=10,message = "昵称不能超过十个字符")
                                   @NotBlank(message = "昵称不能为空")
                                            String name,
                                   @RequestParam("password")@NotBlank(message = "密码不能为空")
                                            String password
                                   ){

        log.info("email地址为{}的用户正在注册",emailAddr);
        return registerService.register(uuid, code, emailAddr, name, password);// 返回 账户account
    }

    @Operation(summary = "",description = "")
    @GetMapping("/localSeq")
    public ApiResponse<List<LocalSeq>> getLocalSeq(){
        String userId = AuthUtil.getUserId();
        List<LocalSeq>localSeqList = loginService.getLocalSeq(Long.valueOf(userId));
        return ApiResponse.success(localSeqList);
    }

    //修改密码
    @Operation(summary = "",description = "")
    @PostMapping("/beforeResetPassword")
    @LimitPWReset
    public ApiResponse<?> beforeResetPassword(){
        Long userId = Long.valueOf(AuthUtil.getUserId());
        String uuid = registerService.beforeResetPassword(userId);
        if(uuid == null){
            return ApiResponse.fail("请稍后再试");
        }
        return ApiResponse.success(uuid);
    }

    @Operation(summary = "",description = "")
    @PostMapping("/resetPassword")
    public ApiResponse<?>resetPassword(@RequestParam("uuid")String uuid,
                                       @RequestParam("code")String code,
                                       @RequestParam("newPassword")String newPassword){
        Long userId = Long.valueOf(AuthUtil.getUserId());
        return registerService.resetPassword(uuid,code,userId,newPassword);
    }



}

==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Controller\FriendController.java ====
package com.example.demo.Controller;

import com.example.demo.DTO.ApiResponse;
import com.example.demo.Service.FriendService;
import com.example.demo.Tools.AuthUtil;
import com.example.demo.VO.UserInfo;
import io.swagger.v3.oas.annotations.Operation;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/friend")
@RequiredArgsConstructor
public class FriendController {

    private final FriendService friendService;


    @Operation(summary = "",description = "")
    @PostMapping("/remove")
    public ApiResponse<String> removeFriend(@RequestParam("friend_id")String friend_id){
        Long user_id = Long.valueOf(AuthUtil.getUserId());
        friendService.removeFriend(user_id,Long.valueOf(friend_id));
        return ApiResponse.success();
    }

    @Operation(summary = "",description = "")
    @GetMapping("/friendList")
    public ApiResponse<List<UserInfo>>getFriendList(){
        Long user_id = Long.valueOf(AuthUtil.getUserId());
        return ApiResponse.success(friendService.getFriendList(user_id));

    }

}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Controller\GroupController.java ====
package com.example.demo.Controller;


import com.example.demo.AOP.LimitCreateGroup;
import com.example.demo.DTO.ApiResponse;
import com.example.demo.DTO.CreateGroupReq;
import com.example.demo.Service.GroupSearchService;
import com.example.demo.VO.GroupShortInfo;
import com.example.demo.Service.GroupService;
import com.example.demo.Tools.AuthUtil;
import com.example.demo.VO.UserInfo;
import io.swagger.v3.oas.annotations.Operation;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/group")
@RequiredArgsConstructor
public class GroupController {

    private final GroupService groupService;
    private final GroupSearchService groupSearchService;
    private Long getUserId(){
        return Long.valueOf(AuthUtil.getUserId());
    }

    @LimitCreateGroup
    @Operation(summary = "",description = "")
    @PostMapping("/create")
    public ApiResponse<String>createGroup(@RequestBody CreateGroupReq createGroupReq){
        groupService.createGroup(createGroupReq,getUserId());
        return ApiResponse.success();
    }

    @Operation(summary = "",description = "")
    @PostMapping("/leave")
    public ApiResponse<String> leaveGroup(@RequestParam("group_id")String group_id){
        if(groupService.leaveGroup(getUserId(),Long.valueOf(group_id))){
            return ApiResponse.success();
        }else{
            return ApiResponse.fail("无法退出你不在的群组");
        }
    }

    @Operation(summary = "",description = "")
    @RequestMapping("/removeMember")
    public ApiResponse<?> removeMember(@RequestParam("group_id")String group_id,
                                       @RequestParam("member_id")String member_id){
        groupService.removeMembersFromGroup(Long.valueOf(group_id),Long.valueOf(member_id),getUserId());
        return ApiResponse.success();
    }

    @Operation(summary = "",description = "")
    @PostMapping("/disband")
    public ApiResponse<String> disbandGroup(@RequestParam("group_id")String group_id){
        groupService.disbandGroup(Long.valueOf(group_id),getUserId());
        return ApiResponse.success();
    }

    @Operation(summary = "",description = "")
    @GetMapping("/memberList")
    public ApiResponse<List<UserInfo>>getMemberList(@RequestParam("group_id")String group_id){
        List<UserInfo> userInfoList = groupService.getMembersInfo(Long.valueOf(group_id));
        if(userInfoList == null) return ApiResponse.fail("群组不存在");
        return ApiResponse.success(userInfoList);
    }

    @GetMapping("/groupInfo")
    public ApiResponse<GroupShortInfo> getGroupInfo(@RequestParam("group_id")String group_id){
        GroupShortInfo groupShortInfo = groupSearchService.getGroupShortInfo(Long.valueOf(group_id));
        if(groupShortInfo != null){
            return ApiResponse.success(groupShortInfo);
        }
        return ApiResponse.fail("获取群信息失败");


    }


    @PostMapping("/changeName")
    public ApiResponse<String> changeGroupName(@RequestParam("newName")String newName,
                                               @RequestParam("group_id")String group_id){
        if(newName == null || group_id == null){
            return ApiResponse.fail("输入信息无效！");
        }
        if(Boolean.TRUE.equals(groupService.updateGroupName(newName,Long.valueOf(group_id),getUserId()))){
            return ApiResponse.success();
        }
        return ApiResponse.fail("更新群组名称失败！");
    }

    @PostMapping("/changeSignature")
    public ApiResponse<String> changeGroupSignature(@RequestParam("newSignature")String newSignature,
                                               @RequestParam("group_id")String group_id){
        if(newSignature == null || group_id == null){
            return ApiResponse.fail("输入信息无效！");
        }
        if(Boolean.TRUE.equals(groupService.updateGroupSignature(newSignature,Long.valueOf(group_id),getUserId()))){
            return ApiResponse.success();
        }
        return ApiResponse.fail("更新群组签名失败！");

    }

    @PostMapping("/changeAvatar")
    public ApiResponse<String> changeGroupAvatar(@RequestParam("newName")String newAvatar,
                                               @RequestParam("group_id")String group_id){
        if(newAvatar == null || group_id == null){
            return ApiResponse.fail("输入信息无效！");
        }
        if(Boolean.TRUE.equals(groupService.updateGroupAvatar(newAvatar,Long.valueOf(group_id),getUserId()))){
            return ApiResponse.success();
        }
        return ApiResponse.fail("更新群组头像失败！");

    }


    @GetMapping("/groupList")
    public ApiResponse<List<GroupShortInfo>> getGroupList(){
        List<GroupShortInfo> groupShortInfos = groupService.getGroupList(getUserId());
        return ApiResponse.success(groupShortInfos);
    }



    



}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Controller\MessageController.java ====
package com.example.demo.Controller;


import com.example.demo.DTO.*;
import com.example.demo.Entity.Message;
import com.example.demo.Service.MessageService;
import com.example.demo.Service.TokenService;
import com.example.demo.Tools.AuthUtil;
import io.swagger.v3.oas.annotations.Operation;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.messaging.handler.annotation.MessageMapping;
import org.springframework.messaging.handler.annotation.Payload;
import org.springframework.messaging.simp.annotation.SendToUser;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import java.security.Principal;
import java.util.List;

@RestController
@RequestMapping("/message")
@RequiredArgsConstructor
@Slf4j
public class MessageController {

    private final MessageService messageService;
    private final TokenService tokenService;

    @MessageMapping("/sendPersonalMessage")
    @SendToUser("/queue/ack")
    public AckMessage sendPersonalMessage(@Payload StorageReq storageReq,Principal sender){
        String uuid = sender.getName();
        Long userId = tokenService.getUserIdByUUID(uuid);
        if(messageService.personalMessageSend(storageReq,userId)){
            return new AckMessage(storageReq.getUuid(),true);
        }
        return new AckMessage(storageReq.getUuid(),false);

    }

    @MessageMapping("/sendMessage")
    public void sendMessage(@Payload MessageSendReq messageSendReq, Principal sender){
        String uuid = sender.getName();
        Long userId = tokenService.getUserIdByUUID(uuid);
        log.info("uuid为{}，userid为{}的用户尝试发送消息",uuid,userId);
        messageSendReq.setSender_id(String.valueOf(userId));

        messageService.messageSend(messageSendReq);
    }

    @Operation(summary = "",description = "")
    @GetMapping("/getMaxSeq")
    public ApiResponse<List<SeqResp>> getMaxSeq(){
        String userId = AuthUtil.getUserId();
        List<SeqResp>seqRespList = messageService.getMaxSeq(Long.valueOf(userId));
        return ApiResponse.success(seqRespList);

    }

    @Operation(summary = "",description = "")
    @GetMapping("/getMessages")
    public ApiResponse<List<Message>> getMessages(@RequestParam("minSeq")Long minSeq,
                                                  @RequestParam("maxSeq")Long maxSeq,
                                                  @RequestParam("conversation_id")String conversation_id,
                                                  @RequestParam("relation_type")String relation_type){
        String userId = AuthUtil.getUserId();
        log.info("{}尝试得到消息",userId);
        log.info("seq:   {}-{}",minSeq,maxSeq);
        List<Message>messages = messageService.getMessagesBySeq(minSeq,maxSeq,conversation_id,Long.valueOf(userId),relation_type);
        if(messages.isEmpty()){
            return ApiResponse.fail("cant get messages");
        }
        return ApiResponse.success(messages);

    }


    @MessageMapping("/sendAckReadInfo")
    public void sendAckReadInfo(@Payload AckReadInfo ackReadInfo,Principal sender){
        String uuid = sender.getName();
        Long userId = tokenService.getUserIdByUUID(uuid);
        log.info("{} 发来确认信息， 对话id是{}，newseq是 {}",userId,ackReadInfo.getConversationId(),ackReadInfo.getNewSeq());
        messageService.ack(userId,ackReadInfo.getConversationId(),ackReadInfo.getNewSeq());
    }






}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Controller\RTCController.java ====
package com.example.demo.Controller;

import com.example.demo.DTO.*;
import com.example.demo.Service.RTCService;
import com.example.demo.Service.TokenService;
import io.swagger.v3.oas.annotations.Operation;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.messaging.handler.annotation.MessageMapping;
import org.springframework.messaging.handler.annotation.Payload;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.security.Principal;

@RequiredArgsConstructor
@RestController
@Slf4j
@RequestMapping("/rtc")
public class RTCController {

    private final RTCService rtcService;
    private final TokenService tokenService;
    private String getUserId(String senderName){
        Long userId = tokenService.getUserIdByUUID(senderName);
        return String.valueOf(userId);
    }


    @Operation(summary = "",description = "")
    @GetMapping("/turnToken")
    public ApiResponse<IceServer> getTurnToken(){
        IceServer iceServer = rtcService.getTurnToken();
        if(iceServer != null){
            log.info("successfully get turnToken {} ",iceServer.getUrls());
            return ApiResponse.success(iceServer);
        }else {
            log.error("用户获取turnToken失败");
            return ApiResponse.fail("ERROR");
        }
    }

    @MessageMapping("/callRequest")
    public void callSomebody(@Payload CallRequest callRequest, Principal sender){
        callRequest.setFrom(getUserId(sender.getName()));
        rtcService.sendCallRequest(callRequest);

    }

    @MessageMapping("/callResponse")
    public void sendCallResponse(@Payload CallResponse callResponse, Principal sender){
        if(!callResponse.getType().equals("approve") && !callResponse.getType().equals("reject")){
            return;
        }
        callResponse.setFrom(getUserId(sender.getName()));
        rtcService.sendCallResponse(callResponse);

    }


    @MessageMapping("/sendIceCandidateMessage")
    public void sendIceCandidate(@Payload CandidateMessage candidateMessage, Principal sender){
        candidateMessage.setFrom(getUserId(sender.getName()));
        rtcService.candidateMessageSend(candidateMessage);

    }

    @MessageMapping("/sendSignalMessage")
    public void sendSignalMessage(@Payload SignalMessage signalMessage, Principal sender){
        signalMessage.setFrom(getUserId(sender.getName()));
        rtcService.signalMessageSend(signalMessage);
    }





}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Controller\UploadController.java ====
package com.example.demo.Controller;


import com.example.demo.AOP.LimitUpload;
import com.example.demo.DTO.ApiResponse;
import com.example.demo.DTO.GetFileResponse;
import com.example.demo.DTO.UploadInitResponse;
import com.example.demo.Service.UploadService;
import com.example.demo.Tools.AuthUtil;
import io.swagger.v3.oas.annotations.Operation;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;

import java.util.List;

@RestController
@Slf4j
@RequiredArgsConstructor
@RequestMapping("/test")
public class UploadController {
    private final UploadService uploadService;
    private Long getUserId(){
        return Long.valueOf(AuthUtil.getUserId());
    }

    @Operation(summary = "",description = "")
    @RequestMapping("/easyUpload")
    @LimitUpload
    public ApiResponse<String> easyUpload(@RequestParam("filehash") String filehash,
                                          @RequestParam("filename") String filename,
                                          @RequestParam("size") String size,
                                          @RequestParam("type") String type,
                                          @RequestParam("file") MultipartFile file,
                                          @RequestParam("isPrivate") boolean isPrivate){
        Long userId = getUserId();
        if(uploadService.easyUpload(userId,filehash,filename,Long.valueOf(size),type,file,isPrivate)){
            return ApiResponse.success();
        }
        return ApiResponse.fail("上传失败");
    }


    @Operation(summary = "",description = "")
    @RequestMapping("/initUpload")
    @LimitUpload
    public ApiResponse<UploadInitResponse> initUpload(@RequestParam("filehash")String filehash,
                                                      @RequestParam("filename") String filename,
                                                      @RequestParam("size") String size,
                                                      @RequestParam("type") String type,
                                                      @RequestParam("isPrivate") boolean isPrivate,
                                                      @RequestParam("totalParts")Integer totalParts
                                                      ){
        Long userId = getUserId();
        log.info("接收到来自的account为 {}的用户的上传请求，filename： {}",userId,filename);
        UploadInitResponse response = uploadService.initUpload(userId,filehash,filename,Long.valueOf(size),type,isPrivate,totalParts);
        log.info("uploadId: {}",response.getUploadId());
        return ApiResponse.success(response);
    }



    @Operation(summary = "",description = "")
    @RequestMapping("/uploadPart")
    public ApiResponse<Boolean> uploadPart(@RequestParam("filehash") String filehash,
                                           @RequestParam("partNumber") Integer partNumber,
                                           @RequestParam("chunkFile") MultipartFile chunkFile){
        Long userId = getUserId();
        if(uploadService.uploadPart(userId,filehash,partNumber,chunkFile)){
            log.info("{}上传成功",partNumber);
            return ApiResponse.success(true);
        }else{
            return ApiResponse.fail("failed to upload this part"+partNumber);
        }

    }


    @Operation(summary = "",description = "")
    @GetMapping("/getMissingParts")
    public ApiResponse<List<Integer>> getMissingParts(@RequestParam("filehash")String filehash){
        List<Integer>missingParts = uploadService.getMissingParts(getUserId(),filehash);
        return ApiResponse.success(missingParts);
    }


    @Operation(summary = "",description = "")
    @RequestMapping("/completeUpload")
    public ApiResponse<Boolean> completeUpload(@RequestParam("filehash")String filehash){
        Long userId =getUserId();
        if(uploadService.completeUpload(userId,filehash)){
            log.info("user: {} filehash: {} 的文件合并成功",userId,filehash);
            return ApiResponse.success(true);
        }else{
            return ApiResponse.fail("failed to complete this upload,user:"+userId+"filehash: "+filehash);
        }

    }

    @Operation(summary = "",description = "")
    @RequestMapping("/getFileUrl")
    public ApiResponse<GetFileResponse> getFileUrl(@RequestParam("filehash")String filehash){
        GetFileResponse getFileResponse = uploadService.getUrl(getUserId(),filehash);
        if(!(getFileResponse == null)){
            return ApiResponse.success(getFileResponse);
        }
        return ApiResponse.fail("无法得到该文件url");
    }









}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Controller\UserController.java ====
package com.example.demo.Controller;


import com.example.demo.AOP.*;
import com.example.demo.DTO.ApiResponse;
import com.example.demo.DTO.UserSearch;
import com.example.demo.Entity.Storage;
import com.example.demo.Service.UserService;
import com.example.demo.Tools.AuthUtil;
import io.swagger.v3.oas.annotations.Operation;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequiredArgsConstructor
@RequestMapping("/user")
@Slf4j
public class UserController {

    private final UserService userService;
    private Long getUserId(){
        return Long.valueOf(AuthUtil.getUserId());
    }

    private Boolean isValidAccount(String account) {
        if (account == null) return null;
        return account.matches("u\\d{10}");
    }



    @Operation(summary = "",description = "")
    @PostMapping("/changeAvatar")
    @LimitAvatar
    public ApiResponse<String>changeAvatar(@RequestParam("avatar")String avatar){
        userService.changeAvatar(getUserId(),avatar);
        return ApiResponse.success();
    }

    @Operation(summary = "",description = "")
    @PostMapping("/changeNickname")
    @LimitNickname
    public ApiResponse<String>changeNickname(@RequestParam("name")String name){
        userService.changeName(getUserId(),name);
        return ApiResponse.success();
    }

    @Operation(summary = "",description = "")
    @PostMapping("/changeSignature")
    @LimitSignature
    public ApiResponse<String>changeSignature(@RequestParam("signature")String signature){
        userService.changeSignature(getUserId(),signature);
        return ApiResponse.success();
    }

    @Operation(summary = "",description = "")
    @PostMapping("/search")
    public ApiResponse<UserSearch>searchUser(@RequestParam("account")String account){
        if(!isValidAccount(account)){
            log.error("账号不合法！");
            return ApiResponse.fail("账号不合法！");
        }
        log.info("尝试查询账号为{}的用户",account);
        UserSearch userSearch = userService.searchByAccount(account,getUserId());
        if(userSearch == null){
            return ApiResponse.fail("该用户不存在");
        }
        log.info("查询到用户id {}",userSearch.getUserInfo().getId());
        return ApiResponse.success(userSearch);
    }

    @GetMapping("/storage")
    public ApiResponse<List<Storage>>getStorage(@RequestParam("type")String type,//txt,image,audio,video,others,all
                                                @RequestParam("limit")Integer limit,
                                                @RequestParam("offset")Integer offset){
        List<Storage> storageList = userService.getStorage(getUserId(),type,limit,offset);
        return ApiResponse.success(storageList);
    }











}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\DTO\AckMessage.java ====
package com.example.demo.DTO;

import lombok.Data;

@Data
public class AckMessage {
    private String uuid;
    private Boolean sent;

    public AckMessage(String uuid,Boolean sent){
        this.uuid = uuid;
        this.sent = sent;
    }
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\DTO\AckReadInfo.java ====
package com.example.demo.DTO;

import lombok.Data;

@Data
public class AckReadInfo {
    String conversationId;
    Long newSeq;
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\DTO\ApiResponse.java ====
package com.example.demo.DTO;


import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@NoArgsConstructor
@AllArgsConstructor
public class ApiResponse<T> {
    private int code;       // 状态码
    private String message; // 提示信息
    private T data;         // 具体数据

    // 成功响应（带数据）
    public static <T> ApiResponse<T> success(T data) {
        return new ApiResponse<>(200, "success", data);
    }

    // 成功响应（不带数据）
    public static <T> ApiResponse<T> success() {
        return new ApiResponse<>(200, "success", null);
    }

    // 失败响应
    public static <T> ApiResponse<T> fail(int code, String message) {
        return new ApiResponse<>(code, message, null);
    }

    // 通用失败
    public static <T> ApiResponse<T> fail(String message) {
        return new ApiResponse<>(500, message, null);
    }

    //invalid
    public static <T> ApiResponse<T> invalid(String message){return new ApiResponse<>(401,message,null);}
}

==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\DTO\ApplicationReq.java ====
package com.example.demo.DTO;

import jakarta.validation.constraints.Size;
import lombok.Data;

@Data
public class ApplicationReq {
    private String from;
    private String to;
    private String type;
    @Size(max = 50,message = "申请理由不能超过50个字符")
    private String app_desc;
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\DTO\CallRequest.java ====
package com.example.demo.DTO;

import lombok.Data;

@Data
public class CallRequest {
    private String from;
    private String to;
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\DTO\CallResponse.java ====
package com.example.demo.DTO;

import lombok.Data;

@Data
public class CallResponse {
    private String type;//approve   reject
    private String from;
    private String to;
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\DTO\Candidate.java ====
package com.example.demo.DTO;

public class Candidate {
    private String candidate; // candidate 字符串
    private String sdpMid;    // 通道标识
    private Integer sdpMLineIndex; // 通道索引

    public Candidate() {}
    public Candidate(String candidate, String sdpMid, Integer sdpMLineIndex) {
        this.candidate = candidate;
        this.sdpMid = sdpMid;
        this.sdpMLineIndex = sdpMLineIndex;
    }

    // getter & setter
    public String getCandidate() { return candidate; }
    public void setCandidate(String candidate) { this.candidate = candidate; }

    public String getSdpMid() { return sdpMid; }
    public void setSdpMid(String sdpMid) { this.sdpMid = sdpMid; }

    public Integer getSdpMLineIndex() { return sdpMLineIndex; }
    public void setSdpMLineIndex(Integer sdpMLineIndex) { this.sdpMLineIndex = sdpMLineIndex; }

}

==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\DTO\CandidateMessage.java ====
package com.example.demo.DTO;

import lombok.Data;

@Data
public class CandidateMessage {
    private String from;
    private String to;
    private Candidate candidate;

}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\DTO\CreateGroupReq.java ====
package com.example.demo.DTO;

import jakarta.validation.constraints.Size;
import lombok.Data;

@Data
public class CreateGroupReq {
    @Size(max = 10,message = "群名称不能超过10个字符")
    private String name;
    @Size(max = 100,message = "群描述不能超过100个字符")
    private String signature;
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\DTO\GetFileResponse.java ====
package com.example.demo.DTO;

public class GetFileResponse {
    private String url;
    private String filename;
    private String type;
    private Long size;

    public GetFileResponse(String url, String filename, String type, Long size){
        this.url = url;
        this.filename = filename;
        this.type = type;
        this.size = size;
    }

    public String getUrl() {
        return url;
    }

    public String getFilename() {
        return filename;
    }

    public String getType() {
        return type;
    }

    public Long getSize() {
        return size;
    }
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\DTO\IceServer.java ====
package com.example.demo.DTO;

import java.util.List;

public class IceServer {
    private List<String> urls;
    private String username;
    private String credential;

    public String getUsername() {
        return username;
    }



    public List<String> getUrls() {
        return urls;
    }

    public IceServer(List<String> urls, String username, String credential) {
        this.urls=urls;
        this.username = username;
        this.credential = credential;
    }

    public String getCredential() {
        return credential;
    }
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\DTO\LocalSeq.java ====
package com.example.demo.DTO;

import lombok.Data;

@Data
public class LocalSeq {
    private Long sender_id;
    private Long seq;
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\DTO\LoginRequest.java ====
package com.example.demo.DTO;

import lombok.Data;

@Data
public class LoginRequest {
    private LoginType loginType;

    //密码+账号方式登录
    private String account;
    private String password;

    //邮箱+验证码方式登录
    private String email;
    private String code;
    private String uuid;
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\DTO\LoginType.java ====
package com.example.demo.DTO;

public enum LoginType {
    ACCOUNT_PASSWORD,
    EMAIL_CODE
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\DTO\MessageSendReq.java ====
package com.example.demo.DTO;

import lombok.Data;

@Data
public class MessageSendReq {

    private String sender_id;
    private String receiver_id;
    private String content;
    private MessageType type;
    private RelationType relationType;

    public String getType(){
        return type != null ? type.name() : null;
    }

    public String getRelationType(){
        return relationType !=null ? relationType.name() : null;
    }
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\DTO\MessageType.java ====
package com.example.demo.DTO;

public enum MessageType {
    txt,image,audio,video,others
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\DTO\RelationType.java ====
package com.example.demo.DTO;

public enum RelationType {
    FRIEND,GROUP
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\DTO\SdpMessage.java ====
package com.example.demo.DTO;

public class SdpMessage {
    private String type;
    private String sdp;

    public String getType() {
        return type;
    }

    public void setType(String type) {
        this.type = type;
    }

    public String getSdp() {
        return sdp;
    }

    public void setSdp(String sdp) {
        this.sdp = sdp;
    }
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\DTO\SeqResp.java ====
package com.example.demo.DTO;

import lombok.Data;

@Data
public class SeqResp {
    private Long seq;
    private String conversation_id;
    private String relation_type;

    public SeqResp(Long seq,String conversation_id,String relation_type){
        this.seq = seq;
        this.conversation_id = conversation_id;
        this.relation_type = relation_type;

    }
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\DTO\SignalMessage.java ====
package com.example.demo.DTO;

import lombok.Data;

@Data
public class SignalMessage {
    private SdpMessage sdp;  // SDP 字符串
    private String from; // 发送方标识
    private String to;   // 接收方标识

    // 构造器
    public SignalMessage() {}
    public SignalMessage(SdpMessage sdp, String from, String to) {
        this.sdp = sdp;
        this.from = from;
        this.to = to;
    }


}

==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\DTO\StorageReq.java ====
package com.example.demo.DTO;

import lombok.Data;

@Data
public class StorageReq {
    private String uuid;
    private String content;
    private MessageType type;

    public String getType(){
        return type != null ? type.name() : null;
    }
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\DTO\TokenResp.java ====
package com.example.demo.DTO;


import lombok.Data;

@Data
public class TokenResp {
    private String accessToken;
    private String refreshToken;
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\DTO\UploadInitResponse.java ====
package com.example.demo.DTO;

public class UploadInitResponse {
    private String uploadId;
    private Boolean newCreated;


    public String getUploadId() {
        return uploadId;
    }

    public void setUploadId(String uploadId) {
        this.uploadId = uploadId;
    }

    public Boolean getNewCreated() {
        return newCreated;
    }

    public void setNewCreated(Boolean newCreated) {
        this.newCreated = newCreated;
    }
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\DTO\UserPrincipal.java ====
package com.example.demo.DTO;


import java.security.Principal;

public class UserPrincipal implements Principal {
    private final String name;
    public UserPrincipal(String name) { this.name = name; }
    @Override public String getName() { return name; }
}

==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\DTO\UserSearch.java ====
package com.example.demo.DTO;

import com.example.demo.VO.UserInfo;
import lombok.Data;

@Data
public class UserSearch {
    private UserInfo userInfo;
    private boolean isFriend;
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\DTO\WSRequest.java ====
package com.example.demo.DTO;

import java.time.LocalDateTime;

public class WSRequest {
    private String sender;
    private Long receiver;
    private String content;
    private LocalDateTime send_time;

    public String getSender() {
        return sender;
    }

    public void setSender(String sender) {
        this.sender = sender;
    }

    public Long getReceiver() {
        return receiver;
    }

    public void setReceiver(Long receiver) {
        this.receiver = receiver;
    }

    public String getContent() {
        return content;
    }

    public void setContent(String content) {
        this.content = content;
    }

    public LocalDateTime getSend_time() {
        return send_time;
    }

    public void setSend_time(LocalDateTime send_time) {
        this.send_time = send_time;
    }
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Entity\Application.java ====
package com.example.demo.Entity;

import lombok.Data;

import java.time.LocalDateTime;

@Data
public class Application {
    private Long id;
    private Long from_id;
    private Long to_id;
    private Integer status;// -1---不通过   0---申请中  1---同意
    private Boolean is_read;//true --已读
    private String type;// FRIEND  GROUP
    private Long create_time;
    private String app_desc;

    public Application(Long id,Long from,Long to,Integer status,Boolean read,String type,Long create_time,String app_desc){
        this.id = id;
        this.from_id = from;
        this.to_id =to;
        this.status = status;
        this.is_read = read;
        this.type = type;
        this.create_time = create_time;
        this.app_desc = app_desc;
    }
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Entity\FileMeta.java ====
package com.example.demo.Entity;

public class FileMeta {
    private Long id;
    private String filehash;
    private String filename;
    private String type;
    private Long owner_id;
    private Long size;
    private Boolean isPrivate;
    private String bucket;
    private Boolean isCompleted;

    public FileMeta(String filehash, String filename, String type, Long owner_id, Long size,
                    Boolean isPrivate,String bucket,Boolean isCompleted){
        this.filehash = filehash;
        this.filename  = filename;
        this.type = type;
        this.owner_id = owner_id;
        this.size = size;
        this.isPrivate = isPrivate;
        this.bucket = bucket;
        this.isCompleted = isCompleted;
    }
    public String getFilename() {
        return filename;
    }

    public Long getSize() {
        return size;
    }

    public String getType() {
        return type;
    }

    public Long getOwner_id() {
        return owner_id;
    }

    public Boolean getIsPrivate() {
        return isPrivate;
    }

    public String getFilehash() {
        return filehash;
    }

    public String getBucket() {
        return bucket;
    }

    public Boolean getIsCompleted() {
        return isCompleted;
    }



}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Entity\Friend.java ====
package com.example.demo.Entity;

import lombok.Data;

@Data
public class Friend {
    private Long id;
    private Long userId_1;
    private Long userId_2;
    private Long create_time;

    public Friend(Long userId_1,Long userId_2,Long create_time){
        this.userId_1 = userId_1;
        this.userId_2 = userId_2;
        this.create_time = create_time;
    }
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Entity\Group.java ====
package com.example.demo.Entity;

import lombok.Data;

import java.time.LocalDateTime;

@Data
public class Group {
    private Long id;
    private String name;
    private Long owner_id;
    private String avatar;
    private String signature;
    private Integer member_count;
    private Long create_time;

    public Group(Long id,String name,Long owner_id,String avatar,String signature,Integer member_count,Long create_time){
        this.id = id;
        this.name = name;
        this.owner_id = owner_id;
        this.avatar = avatar;
        this.signature = signature;
        this.member_count = member_count;
        this.create_time = create_time;
    }

}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Entity\GroupMember.java ====
package com.example.demo.Entity;

import lombok.Data;
import org.springframework.security.core.parameters.P;

@Data
public class GroupMember {
    private Long id;
    private Long group_id;
    private Long user_id;
    private Long join_time;
    private String role;

    public GroupMember(Long group_id,Long user_id,Long join_time,String role){
        this.group_id = group_id;
        this.user_id = user_id;
        this.join_time = join_time;
        this.role = role;
    }

}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Entity\Message.java ====
package com.example.demo.Entity;

import com.example.demo.DTO.MessageType;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.LocalDateTime;

@Data
@NoArgsConstructor
public class Message {
    private Long id;
    private Long seq;
    private String conversation_id;
    //min(userId_1,userId_2)+ _ + max(userId_1,userId_2)  or g_ + group_id
    private String content; //txt or file_url
    private String type;
    private Long sender_id;
    private Long receiver_id;
    private Long send_time;



    public Message(Long id,Long seq,String conversation_id,String content,String type,Long sender_id,Long receiver_id,Long send_time){

        this.id = id;
        this.seq = seq;
        this.conversation_id = conversation_id;
        this.content = content;
        this.type = type;
        this.sender_id = sender_id;
        this.receiver_id = receiver_id;
        this.send_time = send_time;
    }



}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Entity\ReadRecord.java ====
package com.example.demo.Entity;

import lombok.Data;

@Data
public class ReadRecord {
    private Long id;
    private Long user_id;
    private String conversation_id;
    private Long seq;
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Entity\Storage.java ====
package com.example.demo.Entity;

import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@NoArgsConstructor
public class Storage {
    private Long id;
    private String content; //txt or url
    private String type;// txt,image,audio,video,others
    private Long owner_id;
    private Long send_time;

    public Storage(Long id,String content,String type,Long owner_id,Long send_time){
        this.id = id;
        this.content = content;
        this.type = type;
        this.owner_id = owner_id;
        this.send_time = send_time;
    }
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Entity\User.java ====
package com.example.demo.Entity;

public class User {
    private Long id;
    private String account;
    private String emailAddr;
    private String name;
    private String password;
    private String avatar;
    private String signature;
    private Long createTime;

    public User(Long id,String account,String emailAddr,String name,String password,String avatar,Long createTime){
        this.id = id;
        this.account = account;
        this.emailAddr = emailAddr;
        this.name = name;
        this.password = password;
        this.avatar = avatar;
        this.createTime = createTime;
    }


    public String getAccount() {
        return account;
    }

    public String getEmailAddr() {
        return emailAddr;
    }

    public String getName() {
        return name;
    }

    public String getPassword() {
        return password;
    }

    public Long getCreateTime() {
        return createTime;
    }

    public Long getId() {
        return id;
    }
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Interceptor\AuthHandshakeInterceptor.java ====
package com.example.demo.Interceptor;


import com.example.demo.Component.JwtService;
import com.example.demo.Service.TokenService;
import io.jsonwebtoken.ExpiredJwtException;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.HttpStatus;
import org.springframework.http.server.ServerHttpRequest;
import org.springframework.http.server.ServerHttpResponse;
import org.springframework.stereotype.Component;
import org.springframework.web.socket.WebSocketHandler;
import org.springframework.web.socket.server.HandshakeInterceptor;

import java.net.URI;
import java.util.Map;
@Slf4j
@Component
@RequiredArgsConstructor
public class AuthHandshakeInterceptor implements HandshakeInterceptor {

    private final JwtService jwtService;
    private final TokenService tokenService;

    @Override
    public boolean beforeHandshake(ServerHttpRequest request,
                                   ServerHttpResponse response,
                                   WebSocketHandler wsHandler,
                                   Map<String, Object> attributes) {

        URI uri = request.getURI();
        String query = uri.getQuery();
        String token = null;

        if (query != null) {
            log.info("WS handshake query={}", query);
            for (String p : query.split("&")) {
                if (p.startsWith("token=")) {
                    token = p.substring("token=".length());
                    break;
                }
            }
        }

        if (token == null) {
            log.warn("WS handshake missing token");
            return false;
        }


        //String userId = jwtService.parseToken(token).getSubject();

        String userId;
        try {
            userId = jwtService.parseToken(token).getSubject();
        } catch (ExpiredJwtException e) {
            log.warn("WS handshake failed: token expired");
            response.setStatusCode(HttpStatus.UNAUTHORIZED);
            return false;
        } catch (Exception e) {
            log.warn("WS handshake failed: invalid token {}", e.getMessage());
            response.setStatusCode(HttpStatus.UNAUTHORIZED);
            return false;
        }

        String uuid = tokenService.getUUIDByUserId(Long.valueOf(userId));

        attributes.put("userId", userId);
        if (uuid != null) {
            attributes.put("uuid", uuid);
        }
        log.info("WS handshake success userId={}, uuid={}", userId, uuid);

        return true;
    }

    @Override
    public void afterHandshake(ServerHttpRequest request,
                               ServerHttpResponse response,
                               WebSocketHandler wsHandler,
                               Exception ex) {}
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Mapper\ApplicationMapper.java ====
package com.example.demo.Mapper;



import com.example.demo.Entity.Application;
import com.example.demo.Provider.ApplicationProvider;
import org.apache.ibatis.annotations.*;
import java.util.List;

@Mapper
public interface ApplicationMapper {

    @InsertProvider(type = ApplicationProvider.class, method = "addApplication")
    void addApplication(Application application);

    @SelectProvider(type = ApplicationProvider.class, method = "selectById")
    Application selectById(@Param("id") Long id);

    @SelectProvider(type = ApplicationProvider.class, method = "selectByFT")
    Application selectByFT(@Param("from_id") Long fromId,
                           @Param("to_id") Long toId);

    @UpdateProvider(type = ApplicationProvider.class, method = "updateStatus")
    void updateStatus(@Param("id") Long id,
                      @Param("status") Integer status);

    @UpdateProvider(type = ApplicationProvider.class, method = "updateRead")
    void updateRead(@Param("id") Long id,
                    @Param("is_read") Boolean isRead);

    @SelectProvider(type = ApplicationProvider.class, method = "selectSentApplication")
    List<Application> selectSentApplication(@Param("from_id") Long fromId);

    @SelectProvider(type = ApplicationProvider.class, method = "selectReceiveApplication")
    List<Application> selectReceiveApplication(@Param("to_id") Long toId);
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Mapper\FileMetaMapper.java ====
package com.example.demo.Mapper;



import com.example.demo.Provider.FileMetaProvider;
import com.example.demo.Entity.FileMeta;
import org.apache.ibatis.annotations.*;

@Mapper
public interface FileMetaMapper {

    @InsertProvider(type = FileMetaProvider.class, method = "insertFileMeta")
    int insertFileMeta(FileMeta fileMeta);


    @UpdateProvider(type = FileMetaProvider.class, method = "updateIsCompleted")
    int updateIsCompleted(
            @Param("userId") String userId,
            @Param("filehash") String filehash,
            @Param("is_completed") boolean is_completed
    );


    @SelectProvider(type = FileMetaProvider.class, method = "selectFileMeta")
    FileMeta selectFileMeta(
            @Param("userId") String userId,
            @Param("filehash") String filehash
    );
}

==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Mapper\FriendMapper.java ====
package com.example.demo.Mapper;


import com.example.demo.Entity.Friend;
import com.example.demo.Provider.FriendProvider;
import org.apache.ibatis.annotations.*;

        import java.util.List;

@Mapper
public interface FriendMapper {

    /** 查询所有好友（某人参与的任何好友关系） */
    @SelectProvider(type = FriendProvider.class, method = "selectFriendIds")
    List<Long> selectFriendIds(@Param("userId") Long userId);


    /** 添加好友 */
    @InsertProvider(type = FriendProvider.class, method = "addFriend")
    int addFriend(
            @Param("userId_1") Long userId1,
            @Param("userId_2") Long userId2,
            @Param("create_time") Long createTime
    );


    /** 删除好友（互删） */
    @DeleteProvider(type = FriendProvider.class, method = "removeFriend")
    int removeFriend(
            @Param("userId_1") Long userId1,
            @Param("userId_2") Long userId2
    );
}

==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Mapper\GroupMapper.java ====
package com.example.demo.Mapper;


import com.example.demo.Entity.Group;
import com.example.demo.Provider.GroupProvider;
import com.example.demo.VO.GroupShortInfo;
import org.apache.ibatis.annotations.*;

@Mapper
public interface GroupMapper {

    @InsertProvider(type = GroupProvider.class, method = "createGroup")
    void createGroup(Group group);

    @DeleteProvider(type = GroupProvider.class, method = "disbandGroup")
    void disbandGroup(@Param("groupId") Long groupId);

    @SelectProvider(type = GroupProvider.class, method = "findOwner")
    Long findOwner(@Param("groupId") Long groupId);

    @UpdateProvider(type = GroupProvider.class, method = "updateName")
    void updateName(@Param("groupId") Long groupId, @Param("newName") String newName);

    @UpdateProvider(type = GroupProvider.class, method = "updateSignature")
    void updateSignature(@Param("groupId") Long groupId, @Param("newSignature") String newSignature);

    @UpdateProvider(type = GroupProvider.class, method = "updateAvatar")
    void updateAvatar(@Param("groupId") Long groupId, @Param("newAvatar") String newAvatar);

    @UpdateProvider(type = GroupProvider.class, method = "increaseCount")
    void increaseCount(@Param("groupId") Long groupId);

    @UpdateProvider(type = GroupProvider.class, method = "decreaseCount")
    void decreaseCount(@Param("groupId") Long groupId);

    @SelectProvider(type = GroupProvider.class, method = "selectVOById")
    GroupShortInfo selectVOById(@Param("groupId") Long groupId);
}

==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Mapper\GroupMemberMapper.java ====
package com.example.demo.Mapper;


import com.example.demo.Entity.GroupMember;
import com.example.demo.Provider.GroupMemberProvider;
import org.apache.ibatis.annotations.*;

import java.util.List;

@Mapper
public interface GroupMemberMapper {

    /** 查询用户加入的所有群 */
    @SelectProvider(type = GroupMemberProvider.class, method = "selectGroups")
    List<Long> selectGroups(@Param("user_id") Long userId);


    /** 查询群里的所有成员 */
    @SelectProvider(type = GroupMemberProvider.class, method = "selectMembers")
    List<Long> selectMembers(@Param("group_id") Long groupId);


    /** 添加群成员 */
    @InsertProvider(type = GroupMemberProvider.class, method = "addGroupMember")
    int addGroupMember(
            @Param("group_id") Long groupId,
            @Param("user_id") Long userId,
            @Param("join_time") Long joinTime,
            @Param("role") String role
    );


    /** 移除某个成员 */
    @DeleteProvider(type = GroupMemberProvider.class, method = "removeMember")
    int removeMember(
            @Param("group_id") Long groupId,
            @Param("user_id") Long userId
    );


    /** 解散群（删除所有成员） */
    @DeleteProvider(type = GroupMemberProvider.class, method = "disbandGroup")
    int disbandGroup(@Param("group_id") Long groupId);
}

==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Mapper\MessageMapper.java ====
package com.example.demo.Mapper;


import com.example.demo.Entity.Message;
import com.example.demo.Provider.MessageProvider;
import org.apache.ibatis.annotations.InsertProvider;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;
import org.apache.ibatis.annotations.SelectProvider;

import java.util.List;

@Mapper
public interface MessageMapper {

    @SelectProvider(type = MessageProvider.class, method = "selectMaxSeq")
    Long selectMaxSeq(@Param("conversationId") String conversationId);

    @SelectProvider(type = MessageProvider.class, method = "selectById")
    Message selectById(@Param("messageId") Long messageId);

    @SelectProvider(type = MessageProvider.class, method = "selectBySeqCon")
    Message selectBySeqCon(@Param("seq") Long seq, @Param("conversationId") String conversationId);

    @InsertProvider(type = MessageProvider.class, method = "insertMessage")
    void insertMessage(Message msg);

    @InsertProvider(type = MessageProvider.class, method = "insertBatch")
    void insertBatch(@Param("list") List<Message> messages);
}

==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Mapper\ReadRecordMapper.java ====
package com.example.demo.Mapper;


import com.example.demo.Entity.ReadRecord;
import com.example.demo.Provider.ReadRecordProvider;
import org.apache.ibatis.annotations.*;

import java.util.List;

@Mapper
public interface ReadRecordMapper {

    @InsertProvider(type = ReadRecordProvider.class, method = "insertReadRecord")
    void insertReadRecord(
            @Param("userId") Long userId,
            @Param("conversationId") String conversationId,
            @Param("seq") Long seq
    );

    @UpdateProvider(type = ReadRecordProvider.class, method = "updateSeq")
    void updateSeq(
            @Param("userId") Long userId,
            @Param("conversationId") String conversationId,
            @Param("newSeq") Long newSeq
    );

    @SelectProvider(type = ReadRecordProvider.class, method = "selectReadRecords")
    List<ReadRecord> selectReadRecords(@Param("userId") Long userId);

    @DeleteProvider(type = ReadRecordProvider.class, method = "removeReadRecord")
    void removeReadRecord(
            @Param("userId") Long userId,
            @Param("conversationId") String conversationId
    );
}

==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Mapper\StorageMapper.java ====
package com.example.demo.Mapper;


import com.example.demo.Entity.Storage;
import com.example.demo.Provider.StorageProvider;
import org.apache.ibatis.annotations.InsertProvider;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;
import org.apache.ibatis.annotations.SelectProvider;

import java.util.List;

@Mapper
public interface StorageMapper {

    @InsertProvider(type = StorageProvider.class, method = "insertStorage")
    void insertStorage(Storage storage);

    @SelectProvider(type = StorageProvider.class, method = "selectStorage")
    List<Storage> selectStorage(
            @Param("userId") Long userId,
            @Param("type") String type,
            @Param("limit") Integer limit,
            @Param("offset") Integer offset
    );


}

==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Mapper\UserMapper.java ====
package com.example.demo.Mapper;

import com.example.demo.Entity.User;
import com.example.demo.Provider.UserProvider;
import com.example.demo.VO.UserInfo;
import org.apache.ibatis.annotations.*;


import java.util.List;

@Mapper
public interface UserMapper {

    // ---- Basic ----
    @SelectProvider(type = UserProvider.class, method = "selectById")
    User selectById(@Param("id") Long id);

    @InsertProvider(type = UserProvider.class, method = "insertUser")
    int insertUser(@Param("user") User user);

    @SelectProvider(type = UserProvider.class, method = "selectIdByAccount")
    Long selectIdByAccount(@Param("account") String account);

    @SelectProvider(type = UserProvider.class, method = "existByEmail")
    boolean existByEmail(@Param("emailAddr") String emailAddr);

    @SelectProvider(type = UserProvider.class, method = "selectByAccount")
    User selectByAccount(@Param("account") String account);

    @SelectProvider(type = UserProvider.class, method = "selectByEmailAddr")
    User selectByEmailAddr(@Param("emailAddr") String emailAddr);

    // ---- View ----
    @SelectProvider(type = UserProvider.class, method = "selectByIdList")
    List<UserInfo> selectByIdList(@Param("ids") List<Long> ids);

    @SelectProvider(type = UserProvider.class, method = "selectInfoById")
    UserInfo selectInfoById(@Param("id") Long id);

    // ---- Update ----
    @UpdateProvider(type = UserProvider.class, method = "updateAvatar")
    void updateAvatar(@Param("userId") Long userId, @Param("avatar") String avatar);

    @UpdateProvider(type = UserProvider.class, method = "updateSignature")
    void updateSignature(@Param("userId") Long userId, @Param("signature") String signature);

    @UpdateProvider(type = UserProvider.class, method = "updateName")
    void updateName(@Param("userId") Long userId, @Param("name") String name);

    @UpdateProvider(type = UserProvider.class, method = "updatePassword")
    void updatePassword(@Param("userId") Long userId, @Param("password") String password);

    @SelectProvider(type = UserProvider.class, method = "selectEmailById")
    String selectEmailById(@Param("id") Long id);
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Provider\ApplicationProvider.java ====
package com.example.demo.Provider;

import org.apache.ibatis.jdbc.SQL;

public class ApplicationProvider {

    public String addApplication(){
        return new SQL(){
            {
                INSERT_INTO("application");
                VALUES("id","#{id}");
                VALUES("from_id","#{from_id}");
                VALUES("to_id","#{to_id}");
                VALUES("status","#{status}");
                VALUES("is_read","#{is_read}");
                VALUES("type","#{type}");
                VALUES("create_time","#{create_time}");
                VALUES("app_desc","#{app_desc}");
            }
        }.toString();
    }

    public String selectById(){
        return new SQL(){
            {
                SELECT("*");
                FROM("application");
                WHERE("id = #{id}");
            }
        }.toString();
    }

    public String selectByFT(){
        return new SQL(){
            {
                SELECT("*");
                FROM("application");
                WHERE("from_id=#{from_id}");
                WHERE("to_id=#{to_id}");
            }
        }.toString();
    }

    public String updateStatus(){
        return new SQL(){
            {
                UPDATE("application");
                SET("status=#{status}");
                WHERE("id=#{id}");
            }
        }.toString();
    }

    public String updateRead(){
        return new SQL(){
            {
                UPDATE("application");
                SET("is_read=#{is_read}");
                WHERE("id=#{id}");
            }
        }.toString();
    }

    public String selectSentApplication(){
        return new SQL(){
            {
                SELECT("*");
                FROM("application");
                WHERE("from_id=#{from_id}");
            }
        }.toString();
    }

    public String selectReceiveApplication(){
        return new SQL(){
            {
                SELECT("*");
                FROM("application");
                WHERE("to_id=#{to_id}");
            }
        }.toString();
    }


}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Provider\FileMetaProvider.java ====
package com.example.demo.Provider;

import org.apache.ibatis.jdbc.SQL;

public class FileMetaProvider {

    public String insertFileMeta(){
        return new SQL(){
            {
                INSERT_INTO("file_meta");
                VALUES("id","#{id}");
                VALUES("filehash","#{filehash}");
                VALUES("filename","#{filename}");
                VALUES("type","#{type}");
                VALUES("owner_id","#{owner_id}");
                VALUES("size","#{size}");
                VALUES("is_private","#{isPrivate}");
                VALUES("bucket","#{bucket}");
                VALUES("is_completed","#{isCompleted}");
            }
        }.toString();
    }

    public String updateIsCompleted(){
        return new SQL(){
            {
                UPDATE("file_meta");
                SET("is_completed=#{is_completed}");
                WHERE("owner_id=#{userId}");
                WHERE("filehash=#{filehash}");

            }
        }.toString();
    }

    public String selectFileMeta(){
        return new SQL(){
            {
                SELECT("*");
                FROM("file_meta");
                WHERE("owner_id=#{userId}");
                WHERE("filehash=#{filehash}");

            }
        }.toString();
    }
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Provider\FriendProvider.java ====
package com.example.demo.Provider;

import org.apache.ibatis.jdbc.SQL;

public class FriendProvider {

    public String selectFriendIds() {
        return new SQL(){{
            SELECT("CASE WHEN user_id_1 = #{userId} THEN user_id_2 ELSE user_id_1 END AS friendId");
            FROM("friend");
            WHERE("user_id_1 = #{userId} OR user_id_2 = #{userId}");
        }}.toString();
    }

    public String addFriend(){
        return new SQL(){
            {
                INSERT_INTO("friend");
                VALUES("user_id_1","#{userId_1}");
                VALUES("user_id_2","#{userId_2}");
                VALUES("create_time","#{create_time}");

            }
        }.toString();

    }

    public String removeFriend(){
        return new SQL(){
            {
                DELETE_FROM("friend");
                WHERE("user_id_1=#{userId_1} AND user_id_2=#{userId_2}"+
                        "OR user_id_1=#{userId_2} AND user_id_2=#{userId_1}");
            }
        }.toString();
    }
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Provider\GroupMemberProvider.java ====
package com.example.demo.Provider;

import org.apache.ibatis.jdbc.SQL;

public class GroupMemberProvider {

    public String selectGroups(){
        return new SQL(){
            {
                SELECT("group_id");
                FROM("group_member");
                WHERE("user_id=#{user_id}");
            }
        }.toString();
    }

    public String selectMembers(){
        return new SQL(){
            {
                SELECT("user_id");
                FROM("group_member");
                WHERE("group_id=#{group_id}");
            }
        }.toString();
    }

    public String addGroupMember(){
        return new SQL(){
            {
                INSERT_INTO("group_member");
                VALUES("group_id","#{group_id}");
                VALUES("user_id","#{user_id}");
                VALUES("join_time","#{join_time}");
                VALUES("role","#{role}");
            }
        }.toString();
    }

    public String removeMember(){
        return new SQL(){
            {
                DELETE_FROM("group_member");
                WHERE("user_id=#{user_id} AND group_id=#{group_id}");
            }
        }.toString();
    }

    public String disbandGroup(){
        return new SQL(){
            {
                DELETE_FROM("group_member");
                WHERE("group_id=#{group_id}");
            }
        }.toString();
    }



}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Provider\GroupProvider.java ====
package com.example.demo.Provider;



import org.apache.ibatis.jdbc.SQL;
import java.util.Map;

public class GroupProvider {

    // 创建群组
    public String createGroup() {
        return new SQL(){{
            INSERT_INTO("group_info");
            VALUES("id", "#{id}");
            VALUES("name", "#{name}");
            VALUES("owner_id", "#{owner_id}");
            VALUES("avatar", "#{avatar}");
            VALUES("signature", "#{signature}");
            VALUES("member_count", "#{member_count}");
            VALUES("create_time", "#{create_time}");
        }}.toString();
    }

    // 解散群
    public String disbandGroup() {
        return new SQL(){{
            DELETE_FROM("group_info");
            WHERE("id = #{groupId}");
        }}.toString();
    }

    // 查询 owner_id
    public String findOwner() {
        return new SQL(){{
            SELECT("owner_id");
            FROM("group_info");
            WHERE("id = #{groupId}");
        }}.toString();
    }

    // 更新名字
    public String updateName() {
        return new SQL(){{
            UPDATE("group_info");
            SET("name = #{newName}");
            WHERE("id = #{groupId}");
        }}.toString();
    }

    // 更新签名
    public String updateSignature() {
        return new SQL(){{
            UPDATE("group_info");
            SET("signature = #{newSignature}");
            WHERE("id = #{groupId}");
        }}.toString();
    }

    // 更新头像
    public String updateAvatar() {
        return new SQL(){{
            UPDATE("group_info");
            SET("avatar = #{newAvatar}");
            WHERE("id = #{groupId}");
        }}.toString();
    }

    // 成员数 +1
    public String increaseCount() {
        return new SQL(){{
            UPDATE("group_info");
            SET("member_count = member_count + 1");
            WHERE("id = #{groupId}");
        }}.toString();
    }

    // 成员数 -1
    public String decreaseCount() {
        return new SQL(){{
            UPDATE("group_info");
            SET("member_count = member_count - 1");
            WHERE("id = #{groupId}");
        }}.toString();
    }

    // 根据 id 查询 GroupShortInfo
    public String selectVOById() {
        return new SQL(){{
            SELECT("*");
            FROM("view_group_info");
            WHERE("id = #{groupId}");
        }}.toString();
    }


}

==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Provider\MessageProvider.java ====
package com.example.demo.Provider;



import com.example.demo.Entity.Message;
import org.apache.ibatis.annotations.Param;
import org.apache.ibatis.jdbc.SQL;

import java.util.List;

public class MessageProvider {

    // 查询某个会话的最大 seq
    public String selectMaxSeq() {
        return new SQL(){{
            SELECT("MAX(seq)");
            FROM("message");
            WHERE("conversation_id = #{conversationId}");
        }}.toString();
    }

    // 根据 messageId 查询
    public String selectById() {
        return new SQL(){{
            SELECT("id, seq, conversation_id, content, type, sender_id, receiver_id, send_time");
            FROM("message");
            WHERE("id = #{messageId}");
        }}.toString();
    }

    // 根据 seq 和 conversationId 查询消息（用于补齐丢失消息）
    public String selectBySeqCon() {
        return new SQL(){{
            SELECT("id, seq, conversation_id, content, type, sender_id, receiver_id, send_time");
            FROM("message");
            WHERE("seq = #{seq}");
            WHERE("conversation_id = #{conversationId}");
        }}.toString();
    }

    // 插入消息
    public String insertMessage() {
        return new SQL(){{
            INSERT_INTO("message");
            VALUES("id", "#{id}");
            VALUES("seq", "#{seq}");
            VALUES("conversation_id", "#{conversation_id}");
            VALUES("content", "#{content}");
            VALUES("type", "#{type}");
            VALUES("sender_id", "#{sender_id}");
            VALUES("receiver_id", "#{receiver_id}");
            VALUES("send_time", "#{send_time}");
        }}.toString();
    }


    //批量插入
    public String insertBatch(@Param("list") List<Message> messages) {
        if (messages == null || messages.isEmpty()) {
            return ""; // 避免报错
        }

        StringBuilder sb = new StringBuilder();
        sb.append("INSERT INTO message (id, seq, conversation_id, content, type, sender_id, receiver_id, send_time) VALUES ");

        for (int i = 0; i < messages.size(); i++) {
            sb.append("(")
                    .append("#{list[").append(i).append("].id},")
                    .append("#{list[").append(i).append("].seq},")
                    .append("#{list[").append(i).append("].conversation_id},")
                    .append("#{list[").append(i).append("].content},")
                    .append("#{list[").append(i).append("].type},")
                    .append("#{list[").append(i).append("].sender_id},")
                    .append("#{list[").append(i).append("].receiver_id},")
                    .append("#{list[").append(i).append("].send_time}")
                    .append(")");
            if (i < messages.size() - 1) {
                sb.append(",");
            }
        }

        return sb.toString();
    }
}

==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Provider\ReadRecordProvider.java ====
package com.example.demo.Provider;



import org.apache.ibatis.jdbc.SQL;

public class ReadRecordProvider {

    // 插入已读记录（新增好友时 seq = -1）
    public String insertReadRecord() {
        return new SQL(){{
            INSERT_INTO("read_record");
            VALUES("user_id", "#{userId}");
            VALUES("conversation_id", "#{conversationId}");
            VALUES("seq", "#{seq}");
        }}.toString();
    }

    // 更新 seq（用户滑动到最新消息时更新）
    public String updateSeq() {
        return new SQL(){{
            UPDATE("read_record");
            SET("seq = #{newSeq}");
            WHERE("user_id = #{userId}");
            WHERE("conversation_id = #{conversationId}");
        }}.toString();
    }

    // 查询用户所有的已读记录
    public String selectReadRecords() {
        return new SQL(){{
            SELECT("id, user_id, conversation_id, seq");
            FROM("read_record");
            WHERE("user_id = #{userId}");
        }}.toString();
    }

    // 删除某条会话的已读记录（比如从对话列表移除）
    public String removeReadRecord() {
        return new SQL(){{
            DELETE_FROM("read_record");
            WHERE("user_id = #{userId}");
            WHERE("conversation_id = #{conversationId}");
        }}.toString();
    }
}

==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Provider\StorageProvider.java ====
package com.example.demo.Provider;


import org.apache.ibatis.jdbc.SQL;
import java.util.Map;

public class StorageProvider {

    // 插入 storage
    public String insertStorage() {
        return new SQL(){{
            INSERT_INTO("storage");
            VALUES("id", "#{id}");
            VALUES("content", "#{content}");
            VALUES("type", "#{type}");
            VALUES("owner_id", "#{owner_id}");
            VALUES("send_time", "#{send_time}");
        }}.toString();
    }

    // 查询 storage（可按 type 过滤 + 分页）
    public String selectStorage(final Map<String,Object> params) {
        String type = (String) params.get("type");

        return new SQL(){{
            SELECT("id, content, type, owner_id, send_time");
            FROM("storage");
            WHERE("owner_id = #{userId}");

            if (type != null && !type.isEmpty()) {
                WHERE("type = #{type}");
            }

            ORDER_BY("send_time DESC");
        }} + " LIMIT #{limit} OFFSET #{offset}";
    }


}

==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Provider\UserProvider.java ====
package com.example.demo.Provider;


import org.apache.ibatis.jdbc.SQL;
import java.util.List;
import java.util.Map;

public class UserProvider {

    public String selectById(Map<String, Object> params) {
        return new SQL(){{
            SELECT("*");
            FROM("user");
            WHERE("id = #{id}");
        }}.toString();
    }

    public String insertUser(Map<String, Object> params) {
        return new SQL(){{
            INSERT_INTO("user");
            VALUES("id", "#{user.id}");
            VALUES("account", "#{user.account}");
            VALUES("email_addr", "#{user.emailAddr}");
            VALUES("name", "#{user.name}");
            VALUES("password", "#{user.password}");
            VALUES("avatar", "#{user.avatar}");
            VALUES("signature", "#{user.signature}");
            VALUES("create_time", "#{user.createTime}");
        }}.toString();
    }

    public String selectIdByAccount(Map<String, Object> params) {
        return new SQL(){{
            SELECT("id");
            FROM("user");
            WHERE("account = #{account}");
        }}.toString();
    }

    public String existByEmail(Map<String, Object> params) {
        return new SQL(){{
            SELECT("count(*)");
            FROM("user");
            WHERE("email_addr = #{emailAddr}");
        }}.toString();
    }

    public String selectByAccount(Map<String, Object> params) {
        return new SQL(){{
            SELECT("*");
            FROM("user");
            WHERE("account = #{account}");
        }}.toString();
    }

    public String selectByEmailAddr(Map<String, Object> params) {
        return new SQL(){{
            SELECT("*");
            FROM("user");
            WHERE("email_addr = #{emailAddr}");
        }}.toString();
    }

    // ---- View User Info ----
    public String selectInfoById(Map<String, Object> params) {
        return new SQL(){{
            SELECT("*");
            FROM("view_user_info");
            WHERE("id = #{id}");
        }}.toString();
    }

    public String selectByIdList(Map<String, Object> params) {
        List<Long> ids = (List<Long>) params.get("ids");

        StringBuilder sb = new StringBuilder();
        sb.append("select id,account,name,avatar,signature from view_user_info where id in (");

        for (int i = 0; i < ids.size(); i++) {
            sb.append("#{ids[").append(i).append("]}");
            if (i < ids.size() - 1) sb.append(",");
        }
        sb.append(")");

        return sb.toString();
    }

    public String updateAvatar(Map<String, Object> params) {
        return new SQL(){{
            UPDATE("user");
            SET("avatar = #{avatar}");
            WHERE("id = #{userId}");
        }}.toString();
    }

    public String updateSignature(Map<String, Object> params) {
        return new SQL(){{
            UPDATE("user");
            SET("signature = #{signature}");
            WHERE("id = #{userId}");
        }}.toString();
    }

    public String updateName(Map<String, Object> params) {
        return new SQL(){{
            UPDATE("user");
            SET("name = #{name}");
            WHERE("id = #{userId}");
        }}.toString();
    }

    public String updatePassword(Map<String, Object> params) {
        return new SQL(){{
            UPDATE("user");
            SET("password = #{password}");
            WHERE("id = #{userId}");
        }}.toString();
    }

    public String selectEmailById(Map<String, Object> params) {
        return new SQL(){{
            SELECT("email_addr");
            FROM("user");
            WHERE("id = #{id}");
        }}.toString();
    }
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Repository\ApplicationRepository.java ====
package com.example.demo.Repository;

import com.example.demo.Entity.Application;
import com.example.demo.Mapper.ApplicationMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
@RequiredArgsConstructor
public class ApplicationRepository {

    private final ApplicationMapper applicationMapper;

    public void addApplication(Application application){
        applicationMapper.addApplication(application);
    }

    public Application selectById(Long id){
        return applicationMapper.selectById(id);
    }

    public Application selectByFT(Long from_id,Long to_id){
        return applicationMapper.selectByFT(from_id,to_id);
    }

    public void updateStatus(Long id,int status){
        applicationMapper.updateStatus(id,status);
    }

    public void updateRead(Long id,Boolean is_read){
        applicationMapper.updateRead(id,is_read);
    }

    public List<Application> selectSentApplication(Long from_id){
        return applicationMapper.selectSentApplication(from_id);
    }

    public List<Application> selectReceiveApplication(Long to_id){
        return applicationMapper.selectReceiveApplication(to_id);
    }
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Repository\FileMetaRepository.java ====
package com.example.demo.Repository;


import com.example.demo.Entity.FileMeta;
import com.example.demo.Mapper.FileMetaMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Repository;

@Repository
@RequiredArgsConstructor
public class FileMetaRepository {
    private final FileMetaMapper fileMetaMapper;

    public void insertFileMeta(FileMeta fileMeta){
        fileMetaMapper.insertFileMeta(fileMeta);
    }

    public void updateIsCompleted(Long userId,String filehash,Boolean is_completed){
        fileMetaMapper.updateIsCompleted(String.valueOf(userId),filehash,is_completed);
    }

    public FileMeta selectFileMeta(Long userId,String filehash){
        return fileMetaMapper.selectFileMeta(String.valueOf(userId),filehash);
    }
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Repository\FriendRepository.java ====
package com.example.demo.Repository;

import com.example.demo.Entity.Friend;

import com.example.demo.Mapper.FriendMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
@RequiredArgsConstructor
public class FriendRepository {
    private final FriendMapper friendMapper;

    public List<Long> selectFriends(Long userId){
        return friendMapper.selectFriendIds(userId);
    }
    public void addFriend(Friend friend){
        friendMapper.addFriend(friend.getUserId_1(),friend.getUserId_2(),friend.getCreate_time());
    }
    public void removeFriend(Long userId_1,Long userId_2){
        friendMapper.removeFriend(userId_1,userId_2);
    }



}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Repository\GroupMemberRepository.java ====
package com.example.demo.Repository;


import com.example.demo.Entity.GroupMember;
import com.example.demo.Mapper.GroupMemberMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
@RequiredArgsConstructor
public class GroupMemberRepository {

    private final GroupMemberMapper groupMemberMapper;

    public List<Long> selectGroups(Long user_id){
        return groupMemberMapper.selectGroups(user_id);
    }

    public List<Long> selectMembers(Long group_id){
        return groupMemberMapper.selectMembers(group_id);
    }
    public void addGroupMember(GroupMember groupMember){
        groupMemberMapper.addGroupMember(groupMember.getGroup_id(),groupMember.getUser_id(),
                groupMember.getJoin_time(),groupMember.getRole());
    }
    public void removeMember(Long user_id,Long group_id){
        groupMemberMapper.removeMember(group_id,user_id);
    }
    public void disbandGroup(Long group_id){
        groupMemberMapper.disbandGroup(group_id);
    }
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Repository\GroupRepository.java ====
package com.example.demo.Repository;

import com.example.demo.Mapper.GroupMapper;
import com.example.demo.VO.GroupShortInfo;
import com.example.demo.Entity.Group;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Repository;

@Repository
@RequiredArgsConstructor
public class GroupRepository {

    private final GroupMapper groupMapper;
    public void createGroup(Group group){
        groupMapper.createGroup(group);
    }

    public void disbandGroup(Long groupId){
        groupMapper.disbandGroup(groupId);
    }

    public Long findOwner(Long groupId){
        return groupMapper.findOwner(groupId);
    }

    public void updateName(Long groupId,String newName){
        groupMapper.updateName(groupId,newName);
    }

    public void updateSignature(Long groupId,String newSignature){
        groupMapper.updateSignature(groupId,newSignature);
    }

    public void updateAvatar(Long groupId,String newAvatar){
        groupMapper.updateAvatar(groupId,newAvatar);
    }

    public void increaseCount(Long groupId){
        groupMapper.increaseCount(groupId);
    }

    public void decreaseCount(Long groupId){
        groupMapper.decreaseCount(groupId);
    }

    //vm
    public GroupShortInfo selectById(Long groupId){
        return groupMapper.selectVOById(groupId);
    }




}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Repository\MessageRepository.java ====
package com.example.demo.Repository;


import com.example.demo.Entity.Message;
import com.example.demo.Mapper.MessageMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
@RequiredArgsConstructor
public class MessageRepository {
    private final MessageMapper messageMapper;

    public Long selectMaxSeq(String conversationId){
        return messageMapper.selectMaxSeq(conversationId);
    }

    public Message selectById(Long messageId){
        return messageMapper.selectById(messageId);
    }

    public Message selectBySeqCon(Long seq,String conversationId){
        return messageMapper.selectBySeqCon(seq,conversationId);
    }

    public void insertMessage(Message message){
        messageMapper.insertMessage(message);
    };

    public void insertBatch(List<Message>messages){messageMapper.insertBatch(messages);}



}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Repository\ReadRecordRepository.java ====
package com.example.demo.Repository;

import com.example.demo.Entity.ReadRecord;
import com.example.demo.Mapper.ReadRecordMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
@RequiredArgsConstructor
public class ReadRecordRepository {

    private final ReadRecordMapper readRecordMapper;

    public void insertReadRecord(Long userId,String conversationId,Long seq){
        readRecordMapper.insertReadRecord(userId,conversationId,seq);
    }//新增好友时创建 seq为-1

    public void updateSeq(Long userId,String conversationId,Long newSeq){
        readRecordMapper.updateSeq(userId,conversationId,newSeq);
    }

    public List<ReadRecord>selectReadRecords(Long userId){
        return readRecordMapper.selectReadRecords(userId);
    }

    public void removeReadRecord(Long userId,String conversationId){
        readRecordMapper.removeReadRecord(userId,conversationId);
    }

}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Repository\StorageRepository.java ====
package com.example.demo.Repository;

import com.example.demo.Entity.Storage;
import com.example.demo.Mapper.StorageMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
@RequiredArgsConstructor
public class StorageRepository {

    private final StorageMapper storageMapper;

    public void insertStorage(Storage storage){
        storageMapper.insertStorage(storage);
    }

    public List<Storage> selectStorage(Long userId,String type,Integer limit,Integer offset){
        return storageMapper.selectStorage(userId,type,limit,offset);
    }


}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Repository\UserRepository.java ====
package com.example.demo.Repository;


import com.example.demo.VO.UserInfo;
import com.example.demo.Entity.User;
import com.example.demo.Mapper.UserMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
@RequiredArgsConstructor
public class UserRepository {
    private final UserMapper userMapper;

    public User selectById(Long id){
        return userMapper.selectById(id);
    }

    public int addAUser(User user){
        return userMapper.insertUser(user);
    }

    public Long selectIdByAccount(String account){
        return userMapper.selectIdByAccount(account);
    }

    public boolean existByEmail(String emailAddr){
        return userMapper.existByEmail(emailAddr);
    }

    public User selectByAccount(String account){
        return userMapper.selectByAccount(account);
    }

    public User selectByEmailAddr(String emailAddr){
        return userMapper.selectByEmailAddr(emailAddr);
    }

    //View Model
    public List<UserInfo> selectByIdList(List<Long>Ids){
        return userMapper.selectByIdList(Ids);
    }
    public UserInfo selectInfoById(Long userId){
        return userMapper.selectInfoById(userId);
    }

    public void updateAvatar(Long userId,String newAvatar){
        userMapper.updateAvatar(userId,newAvatar);
    }

    public void updateSignature(Long userId,String signature){
        userMapper.updateSignature(userId,signature);
    }

    public void updateName(Long userId,String newName){
        userMapper.updateName(userId,newName);
    }

    public void updatePassword(Long userId,String newPassword){
        userMapper.updatePassword(userId,newPassword);
    }

    public String selectEmailById(Long userId){
        return userMapper.selectEmailById(userId);
    }
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Service\ApplicationService.java ====
package com.example.demo.Service;

import com.example.demo.Component.SnowflakeIdUtils;
import com.example.demo.DTO.ApiResponse;
import com.example.demo.DTO.ApplicationReq;
import com.example.demo.Entity.Application;
import com.example.demo.Repository.ApplicationRepository;
import com.example.demo.Repository.GroupRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.messaging.simp.SimpMessagingTemplate;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
@RequiredArgsConstructor
@Slf4j
public class ApplicationService {

    private final SimpMessagingTemplate messagingTemplate;
    private final ApplicationRepository applicationRepository;
    private final GroupRepository groupRepository;
    private final TokenService tokenService;
    private final SnowflakeIdUtils idGenerator;
    private final MessageCacheService messageCacheService;
    private final GroupService groupService;
    private final FriendService friendService;
    private static final long SEVEN_DAYS = 7L * 24 * 60 * 60 *1000;

    private String getUUIDByUserId(Long userId){
        return tokenService.getUUIDByUserId(userId);
    }


    private void sendApplication(Application application){
        if(application.getType().equals("FRIEND")){
            String uuid = getUUIDByUserId(application.getTo_id());
            if(uuid != null) {
                messagingTemplate.convertAndSendToUser(uuid,"/queue/application",application);
            }
        }
        if(application.getType().equals("GROUP")){
            Long groupOwner = groupRepository.findOwner(application.getTo_id());
            String uuid = getUUIDByUserId(groupOwner);
            if(uuid != null) {
                messagingTemplate.convertAndSendToUser(uuid,"/queue/application",application);
            }
        }
    }

    public ApiResponse<String> operateApplication(ApplicationReq applicationReq){
        Long from_id = Long.valueOf(applicationReq.getFrom());
        Long to_id = Long.valueOf(applicationReq.getTo());
        Application application = applicationRepository.selectByFT(from_id,to_id);
        boolean hasRelations = messageCacheService.hasRelationsNoDb(from_id,to_id,applicationReq.getType());
        if(hasRelations){
            return ApiResponse.fail("无需申请");
        }
        if(application == null){//不是好友 没拉黑 未拒绝 从未申请
            log.info("第一次申请");
        }else{
            int status = application.getStatus();
            if(status == -1 ){//拒绝
                return ApiResponse.fail("对方已拒绝");
            }
            if(System.currentTimeMillis() - application.getCreate_time() <= SEVEN_DAYS){
                return ApiResponse.fail("不能在一周内重复申请");
            }
            //未读或申请中  且已过七天限制
            log.info("未读或申请中  且已过七天限制");

        }
        Application newApplication = new Application(idGenerator.nextId(), from_id,to_id,0,false,
                applicationReq.getType(),System.currentTimeMillis(),applicationReq.getApp_desc());
        applicationRepository.addApplication(newApplication);
        sendApplication(newApplication);
        return ApiResponse.success();
    }


    public void readApplication(Long userId,Long applicationId){
        Application application = applicationRepository.selectById(applicationId);
        if(application == null){
            return;
        }
        if(application.getTo_id().equals(userId)){
            applicationRepository.updateRead(applicationId,true);
        }
    }

    public void respApplication(Long applicationId,Long userId,String result){
        Application application = applicationRepository.selectById(applicationId);
        if(application == null){
            return;
        }
        if(!application.getTo_id().equals(userId)){
            return;
        }
        if(application.getStatus() == 0 && (System.currentTimeMillis() - application.getCreate_time() <= SEVEN_DAYS)){
            if(result.equals("APPROVE")) {
                applicationRepository.updateStatus(applicationId,1);
                if(application.getType().equals("FRIEND")) friendService.addFriend(application.getTo_id(),application.getFrom_id());
                if(application.getType().equals("GROUP")) groupService.addMembersToGroup(application.getTo_id(),application.getFrom_id());

            }
            if(result.equals("REJECT")) applicationRepository.updateStatus(applicationId,-1);

        }
    }

    public List<Application> getSentApplication(Long userId){
        return applicationRepository.selectSentApplication(userId);
    }

    public List<Application>getReceiveApplication(Long userId){
        return applicationRepository.selectReceiveApplication(userId);
    }




}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Service\FriendService.java ====
package com.example.demo.Service;


import com.example.demo.Entity.Friend;
import com.example.demo.Entity.ReadRecord;
import com.example.demo.Repository.FriendRepository;
import com.example.demo.Repository.ReadRecordRepository;
import com.example.demo.VO.UserInfo;
import lombok.RequiredArgsConstructor;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.List;
import java.util.Set;

@Service
@RequiredArgsConstructor
public class FriendService {

    private final FriendRepository friendRepository;
    private final StringRedisTemplate redisTemplate;
    private final MessageCacheService messageCacheService;
    private final UserService userService;
    private final ReadRecordRepository readRecordRepository;

    private String buildKey(Long userId){
        return "friends_id:"+userId;
    }

    private String buildConversationId(Long userId_1,Long userId_2){
        return Math.min(userId_1,userId_2)+"T"+Math.max(userId_1,userId_2);
    }


    private void addRedisFriend(Long userId,Long friendId){
        String key_1 = buildKey(userId);
        String key_2 = buildKey(friendId);
        redisTemplate.opsForSet().add(key_1,String.valueOf(friendId));
        redisTemplate.opsForSet().add(key_2,String.valueOf(userId));
    }

    private void removeRedisFriend(Long userId,Long friendId){
        String key_1 = buildKey(userId);
        String key_2 = buildKey(friendId);
        redisTemplate.opsForSet().remove(key_1,String.valueOf(friendId));
        redisTemplate.opsForSet().remove(key_2,String.valueOf(userId));
    }
    public void addFriend(Long user_id,Long friend_id){
        Friend friend = new Friend(user_id,friend_id,System.currentTimeMillis());
        String conversationId = buildConversationId(user_id,friend_id);
        readRecordRepository.insertReadRecord(user_id,conversationId,-1L);
        readRecordRepository.insertReadRecord(friend_id,conversationId,-1L);
        friendRepository.addFriend(friend);
        addRedisFriend(user_id,friend_id);
    }

    public void removeFriend(Long userId,Long friendId){
        friendRepository.removeFriend(userId,friendId);
        String conversationId = buildConversationId(userId,friendId);
        readRecordRepository.removeReadRecord(userId,conversationId);
        readRecordRepository.removeReadRecord(friendId,conversationId);

        removeRedisFriend(userId,friendId);
    }

    public List<UserInfo>getFriendList(Long user_id){
        Set<String>friendIds_str = messageCacheService.getFriendIds(user_id);
        List<Long>friendIds = new ArrayList<>();
        for(String friend_id_str:friendIds_str){
            Long friend_id = Long.valueOf(friend_id_str);
            friendIds.add(friend_id);
        }
        return userService.batchGetUserInfo(friendIds);

    }

}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Service\GroupDBService.java ====
package com.example.demo.Service;

import com.example.demo.Entity.GroupMember;
import com.example.demo.Repository.GroupMemberRepository;
import com.example.demo.Repository.GroupRepository;
import com.example.demo.Repository.ReadRecordRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Service
@RequiredArgsConstructor
public class GroupDBService {

    private final GroupMemberRepository groupMemberRepository;
    private final ReadRecordRepository readRecordRepository;
    private final GroupRepository groupRepository;

    @Transactional
    public void addMemberDB(GroupMember groupMember){
        groupMemberRepository.addGroupMember(groupMember);
        groupRepository.increaseCount(groupMember.getGroup_id());
        readRecordRepository.insertReadRecord(groupMember.getUser_id(),String.valueOf(groupMember.getGroup_id()),-1L);
    }

    @Transactional
    public void removeMemberDB(Long memberId,Long groupId){
        groupMemberRepository.removeMember(memberId,groupId);
        groupRepository.decreaseCount(groupId);
        readRecordRepository.removeReadRecord(memberId,String.valueOf(groupId));
    }

    @Transactional
    public void disbandGroupDB(Long groupId){
        groupMemberRepository.disbandGroup(groupId);
        groupRepository.disbandGroup(groupId);

    }
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Service\GroupSearchService.java ====
package com.example.demo.Service;

import com.example.demo.Entity.User;
import com.example.demo.Repository.GroupRepository;
import com.example.demo.VO.GroupShortInfo;
import com.example.demo.VO.UserInfo;
import lombok.RequiredArgsConstructor;
import org.redisson.api.RLock;
import org.redisson.api.RedissonClient;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.stereotype.Service;

import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.TimeUnit;

@Service
@RequiredArgsConstructor
public class GroupSearchService {
    private final GroupRepository groupRepository;
    private final StringRedisTemplate redisTemplate;
    private final RedissonClient redissonClient;

    private static final String CACHE_KEY_PREFIX = "groupInfo:";
    private static final long EXPIRE_TIME = 1L; // 1天
    private static final TimeUnit EXPIRE_UNIT = TimeUnit.DAYS;
    private static final String NULL_MARK_FIELD = "_isNull";


    // --- 辅助方法：Map 与 Object 转换 ---
    private GroupShortInfo mapToGroupShortInfo(Long id, Map<Object, Object> entries) {
        return new GroupShortInfo(id,(String) entries.get("name"),
                (String) entries.get("avatar"),(String) entries.get("signature"),(Integer)entries.get("member_count"));
    }

    private Map<String, String> groupShortInfoToMap(GroupShortInfo groupShortInfo) {
        Map<String, String> map = new HashMap<>();
        if (groupShortInfo.getName() != null) map.put("name", groupShortInfo.getName());
        if (groupShortInfo.getAvatar() != null) map.put("avatar", groupShortInfo.getAvatar());
        if (groupShortInfo.getSignature() != null) map.put("signature", groupShortInfo.getSignature());
        return map;
    }


    //获取单个群组信息（含缓存、锁、防穿透）
    public GroupShortInfo getGroupShortInfo(Long groupId) {
        String key = CACHE_KEY_PREFIX + groupId;
        Map<Object, Object> entries = redisTemplate.opsForHash().entries(key);
        if (!entries.isEmpty()) {
            if (entries.containsKey(NULL_MARK_FIELD)) {
                redisTemplate.expire(key, EXPIRE_TIME, EXPIRE_UNIT);
                return null;
            }
            GroupShortInfo groupShortInfo = mapToGroupShortInfo(groupId, entries);
            redisTemplate.expire(key, EXPIRE_TIME, EXPIRE_UNIT);
            return groupShortInfo;
        }

        String lockKey = "lock:group:" + groupId;
        RLock lock = redissonClient.getLock(lockKey);
        int retry = 0;

        while (retry <= 5) {
            try {
                boolean isLocked = lock.tryLock(500, 10000, TimeUnit.MILLISECONDS);
                if (isLocked) {
                    try {
                        entries = redisTemplate.opsForHash().entries(key);
                        if (!entries.isEmpty()) {
                            if (entries.containsKey(NULL_MARK_FIELD)) {
                                return null;
                            }
                            return mapToGroupShortInfo(groupId, entries);
                        }

                        GroupShortInfo groupShortInfo = groupRepository.selectById(groupId);
                        if (groupShortInfo != null) {
                            Map<String, String> hash = groupShortInfoToMap(groupShortInfo);
                            redisTemplate.opsForHash().putAll(key, hash);
                            redisTemplate.expire(key, EXPIRE_TIME, EXPIRE_UNIT);
                            return groupShortInfo;
                        } else {
                            redisTemplate.opsForHash().put(key, NULL_MARK_FIELD, "true");
                            redisTemplate.expire(key, EXPIRE_TIME, EXPIRE_UNIT);
                            return null;
                        }
                    } finally {
                        lock.unlock();
                    }
                } else {
                    retry++;
                    Thread.sleep(200);
                }
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
                break;
            }
        }
        return null;
    }


}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Service\GroupService.java ====
package com.example.demo.Service;

import com.example.demo.Component.DefaultProperties;
import com.example.demo.Component.SnowflakeIdUtils;
import com.example.demo.DTO.CreateGroupReq;
import com.example.demo.Entity.Group;
import com.example.demo.Entity.GroupMember;
import com.example.demo.Repository.GroupMemberRepository;
import com.example.demo.Repository.GroupRepository;
import com.example.demo.Repository.ReadRecordRepository;
import com.example.demo.VO.GroupShortInfo;
import com.example.demo.VO.UserInfo;
import lombok.RequiredArgsConstructor;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.Duration;
import java.util.ArrayList;
import java.util.List;
import java.util.Set;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class GroupService {

    private final GroupMemberRepository groupMemberRepository;
    private final StringRedisTemplate redisTemplate;
    private final GroupRepository groupRepository;
    private final SnowflakeIdUtils idGenerator;
    private final DefaultProperties defaultProperties;
    private final UserService userService;
    private final MessageCacheService messageCacheService;
    private final GroupDBService groupDBService;
    private final GroupSearchService groupSearchService;


    private static final int EXPIRE_HOURS = 24;

    private String buildGroupKey(Long groupId){
        return "group:members:"+groupId;
    }
    private String buildUserKey(Long userId){return "groups_id:"+userId;}

    private void refreshExpire(String key){
        redisTemplate.expire(key, Duration.ofHours(EXPIRE_HOURS));
    }

    private boolean isNotOwner(Long groupId,Long userId){
        Long owner_id = groupRepository.findOwner(groupId);
        return !owner_id.equals(userId);
    }

    private void invalidateCache(Long groupId){
        String key = "groupInfo:"+groupId;
        if(redisTemplate.hasKey(key)){
            redisTemplate.delete(key);
        }
    }




    private void cacheGroupMembers(Long groupId){
        String key = buildGroupKey(groupId);
        if(! redisTemplate.hasKey(key)){
            List<Long>members = groupMemberRepository.selectMembers(groupId);
            if(members.isEmpty()){
                return;
            }
            String[] ids = members.stream().map(String::valueOf).toArray(String[]::new);
            redisTemplate.opsForSet().add(key,ids);
            refreshExpire(key);
        }
    }


    //创建群组
    public void createGroup(CreateGroupReq createGroupReq,Long user_id){
        Long groupId = idGenerator.nextId();
        Group group = new Group(groupId,createGroupReq.getName(),user_id,
                defaultProperties.getUserAvatar(), createGroupReq.getSignature(),1,System.currentTimeMillis());
        groupRepository.createGroup(group);
        addMembersToGroup(groupId,user_id);

    }


    //离开某个群组
    public boolean leaveGroup(Long userId,Long groupId){
        if(!isNotOwner(groupId,userId)){
            return false;//是群主，无法离开群组
        }
        if(messageCacheService.hasRelations(userId,groupId,"GROUP")){
            groupDBService.removeMemberDB(userId,groupId);
            String groupKey = buildGroupKey(groupId);
            String userKey = buildUserKey(userId);
            if(redisTemplate.hasKey(groupKey)){
                redisTemplate.opsForSet().remove(groupKey,String.valueOf(userId));
            }
            if(redisTemplate.hasKey(userKey)){
                redisTemplate.opsForSet().remove(userKey,String.valueOf(groupId));
            }
            return true;
        }else{
            return false;
        }
    }

    //获取群组成员id
    public List<Long>getMembers(Long groupId){
        String key = buildGroupKey(groupId);
        if(!redisTemplate.hasKey(key)) cacheGroupMembers(groupId);//如果没key则fallback
        Set<String>members = redisTemplate.opsForSet().members(key);
        if(members != null && !members.isEmpty()){
            refreshExpire(key);//再次刷新
            return members.stream().map(Long::valueOf).collect(Collectors.toList());
        }
        return null;
    }


    //增加成员到群组
    public void addMembersToGroup(Long groupId,Long userId){
        String key_1 = buildGroupKey(groupId);
        String key_2 = buildUserKey(userId);
        GroupMember groupMember = new GroupMember(groupId,userId,System.currentTimeMillis(),"member");
        groupDBService.addMemberDB(groupMember);
        if(redisTemplate.hasKey(key_1)) {
            redisTemplate.opsForSet().add(key_1, String.valueOf(userId));
        }
        if(redisTemplate.hasKey(key_2)){
            redisTemplate.opsForSet().add(key_2,String.valueOf(groupId));
        }
    }


    //从群组移出成员
    public void removeMembersFromGroup(Long groupId,Long memberId,Long user_id){
        if(isNotOwner(groupId,user_id)){
            return;//不是群主，无权限
        }
        String key_1 = buildGroupKey(groupId);
        String key_2 =buildUserKey(memberId);
        groupDBService.removeMemberDB(memberId,groupId);
        if(redisTemplate.hasKey(key_1)) {
            redisTemplate.opsForSet().remove(key_1, String.valueOf(memberId));
        }
        if(redisTemplate.hasKey(key_2)){
            redisTemplate.opsForSet().remove(key_2,String.valueOf(groupId));
        }
    }

    //解散群组
    public void disbandGroup(Long groupId,Long user_id){
        if(isNotOwner(groupId,user_id)){
            return;//不是群主，无权限
        }
        invalidateCache(groupId);
        String key = buildGroupKey(groupId);
        List<Long> members = getMembers(groupId);
        for(Long member: members){
            String userKey = buildUserKey(member);
            if(redisTemplate.hasKey(userKey)){
                redisTemplate.opsForSet().remove(userKey,String.valueOf(groupId));
            }
        }
        groupDBService.disbandGroupDB(groupId);
        if(redisTemplate.hasKey(key)) {
            redisTemplate.delete(key);
        }

    }



    //更改群组信息
    public boolean updateGroupName(String newName,Long group_id,Long user_id){
        if(isNotOwner(group_id,user_id)){
            return false;//不是群主，无权限
        }

        groupRepository.updateName(group_id,newName);
        invalidateCache(group_id);
        return true;
    }

    public boolean updateGroupSignature(String newSignature,Long group_id,Long user_id){
        if(isNotOwner(group_id,user_id)){
            return false;//不是群主，无权限
        }
        groupRepository.updateSignature(group_id,newSignature);
        invalidateCache(group_id);
        return true;
    }

    public boolean updateGroupAvatar(String newAvatar,Long group_id,Long user_id){
        if(isNotOwner(group_id,user_id)){
            return false;//不是群主，无权限
        }
        groupRepository.updateAvatar(group_id,newAvatar);
        invalidateCache(group_id);
        return true;
    }

    //返回群组成员的信息
    public List<UserInfo> getMembersInfo(Long groupId){
        List<Long>members = getMembers(groupId);
        if(members == null) return null;
        return userService.batchGetUserInfo(members);
    }


    //获取用户所在群组
    public List<GroupShortInfo>getGroupList(Long userId){
        List<GroupShortInfo>groupShortInfos = new ArrayList<>();
        Set<String> ids = messageCacheService.getGroupIds(userId);
        for(String id : ids){
            GroupShortInfo shortInfo = groupSearchService.getGroupShortInfo(Long.valueOf(id));
            groupShortInfos.add(shortInfo);
        }
        return groupShortInfos;
    }


    /*
    public boolean isGroupMember(Long groupId,Long userId){
        String key = buildKey(groupId);
        Boolean isMember = redisTemplate.opsForSet().isMember(key,String.valueOf(userId));
        if(Boolean.TRUE.equals(isMember)){
            return true;
        }
        boolean inDB = relationsRepository.isGroupMember(groupId,userId);
        if(inDB){
            redisTemplate.opsForSet().add(key,String.valueOf(userId));
            refreshExpire(key);
        }
        return inDB;
    }
    */



}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Service\LoginService.java ====
package com.example.demo.Service;

import com.example.demo.Component.JwtService;
import com.example.demo.DTO.LocalSeq;
import com.example.demo.DTO.LoginRequest;
import com.example.demo.DTO.TokenResp;
import com.example.demo.Entity.User;
import com.example.demo.Repository.UserRepository;
import com.example.demo.Tools.PasswordUtil;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.core.task.TaskExecutor;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.stereotype.Service;

import java.util.*;
import java.util.concurrent.CompletableFuture;

@Slf4j
@Service
@RequiredArgsConstructor
public class LoginService {

    private final TokenService tokenService;
    private final JwtService jwtService;
    private final MessageCacheService messageCacheService;
    private final RegisterService registerService;
    private final UserRepository userRepository;
    private final StringRedisTemplate stringRedisTemplate;
    private final ReadRecordService readRecordService;
    private final TaskExecutor taskExecutor;

    //返回此邮件的uuid任务号
    public String sendLoginEmail(String emailAddr){
        return registerService.sendEmail(emailAddr);
    }


    private void cacheAccountAId(User user){
        if(stringRedisTemplate.opsForValue().get("account:"+user.getAccount()) == null){
            stringRedisTemplate.opsForValue().set("account:"+user.getAccount(),String.valueOf(user.getId()));
        }
    }

    public String beforeLoginByEmail(String email_addr){
        return sendLoginEmail(email_addr);
    }

    private TokenResp afterLogin(User user){
        CompletableFuture.runAsync(() ->{
            String uuid = UUID.randomUUID().toString();
            tokenService.saveLoginSession(user.getId(),uuid);
            messageCacheService.cacheRelations(user.getId());//缓存好友关系
            readRecordService.cacheUserReadRecords(user.getId());//缓存已读信息的seq
            cacheAccountAId(user);//缓存account和userId的映射

        },taskExecutor);

        TokenResp tokenResp = new TokenResp();
        tokenResp.setAccessToken(jwtService.generateAccessToken(user.getId(),user.getAccount()));
        String refreshToken = jwtService.generateRefreshToken(user.getId());
        tokenResp.setRefreshToken(refreshToken);
        Map<String,Object>userMap = new HashMap<>();
        userMap.put("userId",String.valueOf(user.getId()));
        userMap.put("account",String.valueOf(user.getAccount()));
        stringRedisTemplate.opsForHash().putAll("refreshToken:"+refreshToken,userMap);
        return tokenResp;

    }


    public TokenResp login(LoginRequest req){
        switch (req.getLoginType()){
            case ACCOUNT_PASSWORD -> {
                log.info("login by ACCOUNT_PASSWORD account={}", req.getAccount());
                User user = userRepository.selectByAccount(req.getAccount());
                if(PasswordUtil.verify(req.getPassword(),user.getPassword())){
                    log.info("password verified userId={}", user.getId());
                    return afterLogin(user);
                }
                else{
                    log.info("password mismatch account={}", req.getAccount());
                    return null;
                }
            }
            case EMAIL_CODE -> {
                log.info("login by EMAIL_CODE email={}", req.getEmail());
                String redisKey = "email:code:"+req.getUuid();
                String realCode = stringRedisTemplate.opsForValue().get(redisKey);
                if(realCode == null){
                    log.info("email code expired uuid={}", req.getUuid());
                    return null;
                }
                if(!realCode.equals(req.getCode())){
                    log.info("email code mismatch uuid={}", req.getUuid());
                    return null;
                }

                if(!userRepository.existByEmail(req.getEmail())){
                    log.info("email not registered email={}", req.getEmail());
                    return null;
                }

                User user = userRepository.selectByEmailAddr(req.getEmail());
                return afterLogin(user);

            }

        }
        return null;
    }

    private long parseSenderId(String conversationId){
        if(conversationId.contains("T")){
            return Long.parseLong(conversationId.split("T")[0]);
        }else{
            return Long.parseLong(conversationId);
        }
    }

    public List<LocalSeq>getLocalSeq(Long userId){
        String key = "readRecord:"+userId;
        if(!stringRedisTemplate.hasKey(key)){
            readRecordService.cacheUserReadRecords(userId);
        }
        Map<Object,Object>map = stringRedisTemplate.opsForHash().entries(key);
        List<LocalSeq>localSeqList = new ArrayList<>();
        for(Map.Entry<Object,Object> e : map.entrySet()){
            LocalSeq localSeq = new LocalSeq();
            localSeq.setSender_id(parseSenderId((String) e.getKey()));
            localSeq.setSeq(Long.parseLong((String) e.getValue()));
            localSeqList.add(localSeq);
        }
        return localSeqList;
    }





























}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Service\MessageCacheService.java ====
package com.example.demo.Service;


import com.example.demo.Entity.Message;
import com.example.demo.Repository.FriendRepository;
import com.example.demo.Repository.GroupMemberRepository;
import com.example.demo.Repository.MessageRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.stereotype.Service;

import java.time.Duration;
import java.util.*;
import java.util.concurrent.TimeUnit;

@Service
@RequiredArgsConstructor
@Slf4j
public class MessageCacheService {

    private final FriendRepository friendRepository;
    private final GroupMemberRepository groupMemberRepository;
    private final MessageRepository messageRepository;
    private final StringRedisTemplate stringRedisTemplate;

    // 限制次数
    private static final int MAX_FALLBACK = 5;
    // 过期时间（分钟）
    private static final long EXPIRE_MINUTES = 1;

    //消息缓存至Redis三天
    private static final long EXPIRE_SECONDS = 3 * 24 * 3600; // 3天

    private String key(Long messageId) {
        return "messageCache:" + messageId;
    }


    //put relations into cache
    public void cacheRelations(Long userId){
        List<Long> FriendIds = friendRepository.selectFriends(userId);
        List<Long> GroupIds = groupMemberRepository.selectGroups(userId);
        for(Long f : FriendIds) {
            stringRedisTemplate.opsForSet().add("friends_id:" + userId, String.valueOf(f));
        }
        for(Long f : GroupIds) {
            stringRedisTemplate.opsForSet().add("groups_id:" + userId, String.valueOf(f));
        }
    }

    //fallback
    //从数据库读好友和群组关系 有fallback 频次限制
    private boolean tryFallback(Long sender_id,Long receiver_id,String relation_type) {
        String key = "fallback:limit:" + sender_id;
        // 增加计数，如果不存在则初始化为1
        Long count = stringRedisTemplate.opsForValue().increment(key);
        if (count != null) {
            // 每次更新 value 时刷新过期时间为 EXPIRE_MINUTES
            stringRedisTemplate.expire(key, EXPIRE_MINUTES, TimeUnit.MINUTES);
            if (count > MAX_FALLBACK) {
                // 超过阈值
                return false;
            }else {
                cacheRelations(sender_id);
                if(relation_type.equals("FRIEND")) {
                    return Boolean.TRUE.equals(stringRedisTemplate.opsForSet().isMember("friends_id:" + sender_id,
                            String.valueOf(receiver_id)));
                }else {
                    return Boolean.TRUE.equals(stringRedisTemplate.opsForSet().isMember("groups_id:" + sender_id,
                            String.valueOf(receiver_id)));
                }
            }
        } else {
            // 增加失败（极少出现）
            return false;
        }

    }


    //verify relations status  检查是否有消息发送权限
    public boolean hasRelations(Long user_id,Long member_id,String relation_type){
        if(relation_type.equals("FRIEND") &&
                Boolean.TRUE.equals(stringRedisTemplate.opsForSet().isMember("friends_id:" + user_id,
                        String.valueOf(member_id)))) {
            return true;
        }else if(relation_type.equals("GROUP") &&
                Boolean.TRUE.equals(stringRedisTemplate.opsForSet().isMember("groups_id:" + user_id,
                        String.valueOf(member_id)))){
            return true;
        } else{
            return tryFallback(user_id,member_id,relation_type);
        }

    }


    //检查是否好友或群组成员  无需fallback
    public boolean hasRelationsNoDb(Long user_id,Long member_id,String relation_type){
        log.info("{} {} {}",user_id,member_id,relation_type);
        if(relation_type.equals("FRIEND") &&
                Boolean.TRUE.equals(stringRedisTemplate.opsForSet().isMember("friends_id:" + user_id, String.valueOf(member_id)))) {
            return true;
        }else return relation_type.equals("GROUP") &&
                Boolean.TRUE.equals(stringRedisTemplate.opsForSet().isMember("groups_id:" + user_id, String.valueOf(member_id)));
    }

    //获取所有好友id
    public Set<String> getFriendIds(Long user_id){
        String key = "friends_id:"+user_id;
        if(!stringRedisTemplate.hasKey(key)){
            cacheRelations(user_id);
        }
        Set<String>friendIds = stringRedisTemplate.opsForSet().members(key);
        if(friendIds == null) friendIds = Collections.emptySet();
        return friendIds;
    }

    //获取所有加入的群组的id
    public Set<String> getGroupIds(Long user_id){
        String key = "groups_id:"+user_id;
        if(!stringRedisTemplate.hasKey(key)){
            cacheRelations(user_id);
        }
        Set<String>groupIds = stringRedisTemplate.opsForSet().members(key);
        if(groupIds == null) groupIds = Collections.emptySet();
        return groupIds;
    }





    //缓存消息
    public void cacheMessage(Message msg) {

        Map<String, String> map = new HashMap<>();

        map.put("id", String.valueOf(msg.getId()));
        map.put("seq", String.valueOf(msg.getSeq()));
        map.put("conversation_id", msg.getConversation_id());
        map.put("content", msg.getContent());
        map.put("type", msg.getType());
        map.put("sender_id", String.valueOf(msg.getSender_id()));
        map.put("receiver_id", String.valueOf(msg.getReceiver_id()));
        map.put("send_time", msg.getSend_time().toString());

        String redisKey = key(msg.getId());

        stringRedisTemplate.opsForHash().putAll(redisKey, map);
        stringRedisTemplate.expire(redisKey, Duration.ofSeconds(EXPIRE_SECONDS));
    }

    /**
     * 从 Redis 读取 Message（Hash → 对象）
     */
    public Message getMessageById(Long messageId) {
        String redisKey = key(messageId);

        Map<Object, Object> map = stringRedisTemplate.opsForHash().entries(redisKey);
        if (map.isEmpty()){
            return messageRepository.selectById(messageId);
        }

        return new Message(Long.valueOf((String) map.get("id")),Long.valueOf((String) map.get("seq")),(String) map.get("conversation_id"),
                (String) map.get("content"), (String) map.get("type"),Long.valueOf((String) map.get("sender_id")),
                Long.valueOf((String) map.get("receiver_id")),Long.valueOf((String) map.get("send_time")));
    }


























}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Service\MessageService.java ====
package com.example.demo.Service;

import com.example.demo.Component.DBMProducer;
import com.example.demo.Component.SnowflakeIdUtils;
import com.example.demo.DTO.*;
import com.example.demo.Entity.Message;
import com.example.demo.Entity.Storage;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.messaging.simp.SimpMessagingTemplate;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.List;
import java.util.Set;

@Slf4j
@Service
@RequiredArgsConstructor
public class MessageService {

    private final SimpMessagingTemplate messagingTemplate;
    private final TokenService tokenService;
    private final StringRedisTemplate redisTemplate;
    private final SnowflakeIdUtils idGenerator;
    private final MessageCacheService  messageCacheService;
    private final TimelineService timelineService;
    private final DBMProducer dbmProducer;
    private final GroupService groupService;
    private final ReadRecordService readRecordService;


    private String getUUIDByUserId(Long userId){
        return tokenService.getUUIDByUserId(userId);
    }


    private void sendAckSeq(Long seq,Long sender_id,String conversation_id,String relation_type){
        String uuid = getUUIDByUserId(sender_id);
        if (uuid != null) {
            SeqResp seqResp = new SeqResp(seq,conversation_id,relation_type);
            messagingTemplate.convertAndSendToUser(uuid, "/queue/messageSeq", seqResp);
        }
    }

    private boolean isUserInConversation(String userId, String conversationId) {
        if (userId == null || conversationId == null) {
            return false;
        }
        String[] parts = conversationId.split("T");
        for (String part : parts) {
            if (userId.equals(part)) {
                return true;
            }
        }
        return false;
    }


    @Async("taskExecutor")
    public void asyncSendSeq(String uuid,SeqResp seqResp){
        try {
            messagingTemplate.convertAndSendToUser(uuid, "/queue/messageSeq", seqResp);
        }catch (Exception e){
            log.error("asyncSendSeq ERROR {} {}",uuid,seqResp,e);
        }
    }

    private void sendSeq(Long seq,Long sender_id,Long receiver_id,String relation_type){
        if(relation_type.equals("FRIEND")) {//发送好友信息
            if(redisTemplate.opsForValue().get("user:online:" + receiver_id) == null){//接收方不在线
                return;
            }
            String conversation_id = Math.min(sender_id,receiver_id)+"T"+Math.max(sender_id,receiver_id);
            String uuid = getUUIDByUserId(receiver_id);
            if (uuid != null) {
                SeqResp seqResp = new SeqResp(seq,conversation_id,"FRIEND");
                asyncSendSeq(uuid,seqResp);
            }
        }else{//发送群组消息
            Long groupId = receiver_id;

            SeqResp seqResp = new SeqResp(seq,String.valueOf(groupId),"GROUP");
            List<Long>members = groupService.getMembers(groupId);
            for(Long m : members){
                if(m.equals(sender_id)){
                    continue;
                }
                if(redisTemplate.opsForValue().get("user:online:" + m) == null){//接收方不在线
                    continue;
                }
                String uuid = getUUIDByUserId(m);
                if (uuid != null) {
                    asyncSendSeq(uuid,seqResp);
                }
            }

        }
    }

    public List<SeqResp> getMaxSeq(Long user_id){
        List<SeqResp> result = new ArrayList<>();
        Set<String> friendIds = messageCacheService.getFriendIds(user_id);
        Set<String> groupIds = messageCacheService.getGroupIds(user_id);
        if(!friendIds.isEmpty()){
            for(String friendId : friendIds){
                String conversationId = Math.min(Long.parseLong(friendId), user_id) + "T" + Math.max(Long.parseLong(friendId), user_id);
                SeqResp seqResp = new SeqResp(timelineService.fetchMaxSeq(conversationId),conversationId,"FRIEND");
                result.add(seqResp);
            }
        }
        if(!groupIds.isEmpty()) {
            for (String groupId : groupIds) {
                String conversationId = groupId;
                SeqResp seqResp = new SeqResp(timelineService.fetchMaxSeq(conversationId), conversationId,"GROUP");
                result.add(seqResp);
            }
        }
        return result;

    }

    //消息到达后端后的操作
    public void messageSend(MessageSendReq messageSendReq){
        String relation_type = messageSendReq.getRelationType();
        Long sender_id = Long.valueOf(messageSendReq.getSender_id());
        Long receiver_id = Long.valueOf(messageSendReq.getReceiver_id());
        //没有权限发送消息
        if(! messageCacheService.hasRelations(sender_id,receiver_id,relation_type)){
            log.error("没有消息发送权限");
            return;
        }
        Long messageId = idGenerator.nextId();
        String conversationId;
        if(relation_type.equals("FRIEND")) {
            conversationId = Math.min(sender_id,receiver_id)+"T"+Math.max(sender_id,receiver_id);
        }else{
            conversationId = String.valueOf(receiver_id);
        }
        // add timeline:{conversationId}  ----->seq  :  messageId
        long seq = timelineService.addMessage(conversationId,messageId);
        log.info("发送消息 relationType={}, conversationId={}, seq={}, messageId={}", relation_type, conversationId, seq, messageId);
        //Long id,Long seq,String conversation_id,String content,String type,Long sender_id,Long receiver_id,LocalDateTime send_time
        Message message = new Message(messageId,seq,conversationId,messageSendReq.getContent(),
                messageSendReq.getType(),sender_id,receiver_id,System.currentTimeMillis());
        //cache message into redis
        messageCacheService.cacheMessage(message);
        //mq
        dbmProducer.sendDBMessage(message);
        //send seq
        sendAckSeq(seq,sender_id,conversationId,relation_type);
        sendSeq(seq,sender_id,receiver_id,relation_type);


    }


    public List<Message> getMessagesBySeq(Long minSeq, Long maxSeq,String conversation_id,Long userId,String relation_type){

        if(!(relation_type.equals("FRIEND") || relation_type.equals("GROUP"))){
            log.error("字段错误{}",relation_type);
            return List.of();
        }

        if(relation_type.equals("FRIEND") && (! isUserInConversation(String.valueOf(userId),conversation_id))) {
            log.error("身份不合法");
            return List.of();
        }

        if(relation_type.equals("GROUP") && (!messageCacheService.hasRelations(userId,Long.valueOf(conversation_id),"GROUP"))) {
            log.error("身份不合法");
            return List.of();
        }

        return timelineService.getMessages(conversation_id,minSeq,maxSeq);

    }

    public void ack(Long userId,String conversationId,Long newSeq){
        readRecordService.updateSeq(userId,conversationId,newSeq);
    }


    public boolean personalMessageSend(StorageReq storageReq,Long userId){
        log.info("{}发送了个人消息",userId);
        String uuid = getUUIDByUserId(userId);
        if(uuid == null){
            log.error("无法找到个人信息");
            return false;
        }
        Long id = idGenerator.nextId();
        Storage storage = new Storage(id,storageReq.getContent(),storageReq.getType(),userId,System.currentTimeMillis());
        dbmProducer.sendDBMessage(storage);
        messagingTemplate.convertAndSendToUser(uuid,"/queue/storage",storage);
        return true;

    }





}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Service\RateLimitService.java ====
package com.example.demo.Service;

import com.example.demo.Component.RateLimitProperties;
import lombok.RequiredArgsConstructor;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.stereotype.Service;

import java.time.Duration;
import java.time.LocalDateTime;
import java.util.concurrent.TimeUnit;

@Service
@RequiredArgsConstructor
public class RateLimitService {

    private static final String KEY_AVATAR = "limit:avatar:";
    private static final String KEY_NICKNAME = "limit:nickname:";
    private static final String KEY_SIGNATURE = "limit:signature:";
    private static final String KEY_APPLICATION = "limit:application:";
    private static final String KEY_CREATE_GROUP = "limit:creategroup:";
    private static final String KEY_SEND_MESSAGE = "limit:sendmessage:";
    private static final String KEY_UPLOAD = "limit:upload:";
    private static final String KEY_PASSWORD_RESET = "limit:passwordreset:";

    private final StringRedisTemplate redis;
    private final RateLimitProperties properties;

    public boolean canChangeAvatar(String userId) {
        return checkDailyLimit(KEY_AVATAR, userId, properties.getAvatarDailyLimit());
    }

    public boolean canChangeNickname(String userId) {
        String key = KEY_NICKNAME + userId;
        Boolean exists = redis.hasKey(key);
        if (Boolean.TRUE.equals(exists)) {
            return false;
        }
        redis.opsForValue().set(key, "1", properties.getNicknameCooldownMinutes(), TimeUnit.MINUTES);
        return true;
    }

    public boolean canChangeSignature(String userId) {
        String key = KEY_SIGNATURE + userId;
        Boolean exists = redis.hasKey(key);
        if (Boolean.TRUE.equals(exists)) {
            return false;
        }
        redis.opsForValue().set(key, "1", properties.getSignatureCooldownMinutes(), TimeUnit.MINUTES);
        return true;
    }

    public boolean canSendApplication(String userId) {
        return checkDailyLimit(KEY_APPLICATION, userId, properties.getApplicationDailyLimit());
    }

    public boolean canCreateGroup(String userId) {
        return checkDailyLimit(KEY_CREATE_GROUP, userId, properties.getCreateGroupDailyLimit());
    }

    public boolean canSendMessage(String userId){
        Duration ttl = Duration.ofMinutes(1);
        return checkWindowLimit(KEY_SEND_MESSAGE, userId, ttl, properties.getMessagePerMinuteLimit());
    }

    public boolean canUpload(String userId){
        return checkDailyLimit(KEY_UPLOAD, userId, properties.getUploadDailyLimit());
    }

    public boolean canResetPassword(String userId){
        return checkDailyLimit(KEY_PASSWORD_RESET, userId, properties.getPasswordResetDailyLimit());
    }

    private boolean checkDailyLimit(String keyPrefix, String userId, long maxCount) {
        String key = keyPrefix + userId;
        Long count = redis.opsForValue().increment(key);
        if (count != null && count == 1) {
            redis.expire(key, getSecondsUntilMidnight(), TimeUnit.SECONDS);
        }
        return count != null && count <= maxCount;
    }

    private boolean checkWindowLimit(String keyPrefix, String userId, Duration ttl, long maxCount) {
        String key = keyPrefix + userId;
        Long count = redis.opsForValue().increment(key);
        if (count != null && count == 1) {
            redis.expire(key, ttl);
        }
        return count != null && count <= maxCount;
    }

    private long getSecondsUntilMidnight() {
        LocalDateTime now = LocalDateTime.now();
        LocalDateTime midnight = now.toLocalDate().plusDays(1).atStartOfDay();
        return Duration.between(now, midnight).getSeconds();
    }
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Service\ReadRecordService.java ====
package com.example.demo.Service;

import com.example.demo.Entity.ReadRecord;
import com.example.demo.Repository.ReadRecordRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Service;

import java.time.Duration;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@Service
@RequiredArgsConstructor
@Slf4j
public class ReadRecordService {

    private final ReadRecordRepository readRecordRepository;
    private final StringRedisTemplate redisTemplate;

    private static final int FLUSH_THRESHOLD = 10;
    private String buildKey(Long userId){
        return "readRecord:"+userId;
    }
    private String buildDirtyKey(Long userId){return "dirty:"+userId;}

    public void cacheUserReadRecords(Long userId){
        String key = buildKey(userId);
        if(redisTemplate.hasKey(key)){
           return;
        }
        List<ReadRecord> readRecords = readRecordRepository.selectReadRecords(userId);
        if(readRecords == null || readRecords.isEmpty()){
            return;
        }
        Map<String,String> map = new HashMap<>();
        for(ReadRecord readRecord : readRecords){
            map.put(readRecord.getConversation_id(),String.valueOf(readRecord.getSeq()));
        }
        redisTemplate.opsForHash().putAll(key,map);
        redisTemplate.expire(key, Duration.ofDays(7));
        log.info("缓存用户已读信息 userId={} size={}", userId, map.size());
    }


    public void flushReadRecordToDB(Long userId) {
        String key = buildKey(userId);
        String dirtyKey = buildDirtyKey(userId);

        // 取 dirty conversation 列表
        List<String> dirtyList = redisTemplate.opsForSet().members(dirtyKey)
                .stream().map(String::valueOf).toList();

        if (dirtyList.isEmpty()) {
            return;
        }

        for (String conversationId : dirtyList) {
            Object val = redisTemplate.opsForHash().get(key, conversationId);
            if (val == null) {
                // 理论不会出现，但安全保护
                redisTemplate.opsForSet().remove(dirtyKey, conversationId);
                continue;
            }
            Long seq = Long.valueOf((String) val);
            readRecordRepository.updateSeq(userId, conversationId, seq);
            log.info("updated!");

            // remove dirty
            redisTemplate.opsForSet().remove(dirtyKey, conversationId);
        }

        // cnt 刷掉（脏标清了就没意义了）
        redisTemplate.delete(key + ":cnt");

        log.info("flush 用户={} dirtyCount={}", userId, dirtyList.size());
    }


    @Async("taskExecutor")
    public void updateSeq(Long userId,String conversationId,Long newSeq){
        String key = buildKey(userId);
        String dirtyKey = buildDirtyKey(userId);
        String cntKey = key+":cnt";
        redisTemplate.opsForSet().add(dirtyKey,conversationId);

        Object oldVal = redisTemplate.opsForHash().get(key,conversationId);
        Long oldSeq = oldVal == null ? -1L : Long.valueOf((String) oldVal);
        if(newSeq<= oldSeq){
            log.error("未更新成功! {} {}",newSeq,oldSeq);
            return;
        }

        redisTemplate.opsForHash().put(key,conversationId,String.valueOf(newSeq));
        Long cnt = redisTemplate.opsForValue().increment(cntKey);
        if(cnt == 1){
            redisTemplate.expire(cntKey,Duration.ofDays(1));
        }
        if(cnt>=FLUSH_THRESHOLD){
            flushReadRecordToDB(userId);
        }
        log.debug("updateSeq userId={} conversationId={} newSeq={} cnt={}", userId, conversationId, newSeq, cnt);
    }

}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Service\RegisterService.java ====
package com.example.demo.Service;

import com.example.demo.Component.DefaultProperties;
import com.example.demo.Component.EmailSender;
import com.example.demo.Component.SnowflakeIdUtils;
import com.example.demo.DTO.ApiResponse;
import com.example.demo.Entity.User;
import com.example.demo.Repository.UserRepository;
import com.example.demo.Tools.CodeUtil;
import com.example.demo.Tools.PasswordUtil;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Service;

import java.util.UUID;
import java.util.concurrent.TimeUnit;

@Service
@Slf4j
@RequiredArgsConstructor
public class RegisterService {

    private final UserRepository userRepository;

    private final EmailSender emailSender;

    private final DefaultProperties defaultProperties;

    private final SnowflakeIdUtils idGenerator;

    private final StringRedisTemplate redisTemplate;

    private String generateAccount() {

        while (true) {
            String account = "u" + CodeUtil.randomNumeric(10);

            Boolean ok = redisTemplate.opsForValue()
                    .setIfAbsent("acc:" + account, "1", 30, TimeUnit.DAYS);

            if (Boolean.TRUE.equals(ok)) {
                return account;   // 只有第一次写入成功时，才认为是唯一账号
            }
        }
    }


    public String sendEmail(String emailAddr){
        String uuid = UUID.randomUUID().toString().replace("-","");
        String code = CodeUtil.generateCode();
        String redisKey = "email:code:"+uuid;
        String limitKey = "email:limit:" + emailAddr;
        Boolean success = redisTemplate.opsForValue().setIfAbsent(limitKey, "1", 60, TimeUnit.SECONDS);
        if (Boolean.FALSE.equals(success)) {
            return ""; //太频繁
        }
        redisTemplate.opsForValue().set(redisKey,code,5, TimeUnit.MINUTES);
        emailSender.sendEmail(emailAddr,code);
        return uuid;
    }


    public ApiResponse<String> register(String uuid, String code, String emailAddr, String name, String password){

        String redisKey = "email:code:"+uuid;
        String realCode = redisTemplate.opsForValue().get(redisKey);
        if(realCode == null){
            log.error("验证码已过期");
            return ApiResponse.fail("验证码已过期");
        }
        if(!realCode.equals(code)){
            log.error("验证码不正确");
            return ApiResponse.fail("验证码不正确");
        }

        if(userRepository.existByEmail(emailAddr)){
            log.error("邮箱已被注册");
            return ApiResponse.fail("邮箱已被注册");
        }
        Long userId = idGenerator.nextId();
        String account = generateAccount();
        redisTemplate.opsForValue().set("account:"+account,String.valueOf(userId));//缓存映射
        User user = new User(userId,account,emailAddr,name,PasswordUtil.hash(password),defaultProperties.getUserAvatar(),
                System.currentTimeMillis());
        log.info("before insert");
        int rows = userRepository.addAUser(user);
        log.info("{}",rows);
        log.info("成功注册用户，account为{}",account);
        return ApiResponse.success(account);
    }

    public String beforeResetPassword(Long userId){
        String emailAddr = userRepository.selectEmailById(userId);
        if(emailAddr == null){
            return null;
        }
        return sendEmail(emailAddr);
    }

    public ApiResponse<String> resetPassword(String uuid, String code, Long userId, String newPassword){
        String redisKey = "email:code:"+uuid;
        String realCode = redisTemplate.opsForValue().get(redisKey);
        if(realCode == null){
            return ApiResponse.fail("验证码已过期");
        }
        if(!realCode.equals(code)){
            return ApiResponse.fail("验证码不正确");
        }
        userRepository.updatePassword(userId,PasswordUtil.hash(newPassword));
        return ApiResponse.success();
    }
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Service\RTCService.java ====
package com.example.demo.Service;


import com.example.demo.Component.TurnTokenUtil;
import com.example.demo.DTO.*;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.messaging.simp.SimpMessagingTemplate;
import org.springframework.stereotype.Service;

import java.time.Duration;

@Service
@Slf4j
@RequiredArgsConstructor
public class RTCService {

    private final TurnTokenUtil turnTokenUtil;

    private final TokenService tokenService;
    private final MessageCacheService messageCacheService;
    private final SimpMessagingTemplate messagingTemplate;
    private final StringRedisTemplate redisTemplate;

    private static final Duration CALL_REQUEST_TTL = Duration.ofSeconds(90);

    // 枚举管理 call 状态
    public enum CallStatus {
        request, approve, reject
    }

    private String buildKey(Long callerId, Long calleeId) {
        return callerId + "CALL" + calleeId;
    }


    public IceServer getTurnToken(){
        return turnTokenUtil.generateCredential();
    }

    private String getUUIDByUserId(Long userId){
        return tokenService.getUUIDByUserId(userId);
    }

    private Boolean getCallPermission(Long from_id,Long to_id){
        String key_1 = buildKey(from_id,to_id);
        String key_2 = buildKey(to_id,from_id);
        String value_1 = redisTemplate.opsForValue().get(key_1);
        String value_2 = redisTemplate.opsForValue().get(key_2);
        Boolean result_1 = (value_1 != null && value_1.equals(CallStatus.approve.name()));
        Boolean result_2 = (value_2 != null && value_2.equals(CallStatus.approve.name()));
        return (result_1 || result_2);
    }

    // 通用检查方法
    private boolean checkSendPermission(Long fromId, Long toId) {
        if (!messageCacheService.hasRelations(fromId, toId, "FRIEND")) {
            log.warn("用户 {} 与 {} 非好友，拒绝发送", fromId, toId);
            return false;
        }
        if (redisTemplate.opsForValue().get("user:online:" + toId) == null) {
            log.warn("接收方 {} 不在线", toId);
            return false;
        }
        if (!getCallPermission(fromId, toId)) {
            log.warn("通话未批准，拒绝发送消息 {} -> {}", fromId, toId);
            return false;
        }
        return true;
    }

    public void sendCallRequest(CallRequest callRequest){
        Long from_id = Long.valueOf(callRequest.getFrom());
        Long to_id = Long.valueOf(callRequest.getTo());
        if(!messageCacheService.hasRelations(from_id,to_id,"FRIEND")){
            log.warn("无权限");
            return;
        }
        String key = buildKey(from_id,to_id);
        String value = redisTemplate.opsForValue().get(key);
        if(value != null ){
            log.warn("不能重复发送请求");
            return;
        }
        if(redisTemplate.opsForValue().get("user:online:" + to_id) == null){
            log.warn("接收方不在线");
            return;
        }
        redisTemplate.opsForValue().set(key,"request", CALL_REQUEST_TTL);
        String uuid = getUUIDByUserId(to_id);
        if(uuid!=null){
            messagingTemplate.convertAndSendToUser(uuid,"/queue/callRequest",callRequest);
        }

    }


    public void sendCallResponse(CallResponse callResponse){
        Long from_id = Long.valueOf(callResponse.getFrom());
        Long to_id = Long.valueOf(callResponse.getTo());
        if(!messageCacheService.hasRelations(from_id,to_id,"FRIEND")){
            log.warn("无权限");
            return;
        }
        String key = buildKey(to_id,from_id);
        String value = redisTemplate.opsForValue().get(key);
        if(value == null){
            log.warn("过期回复");
            return;
        }
        if(!value.equals("request")){
            log.warn("重复回复");
            return;
        }
        if(redisTemplate.opsForValue().get("user:online:" + to_id) == null){
            log.warn("接收方不在线");
            return;
        }
        redisTemplate.opsForValue().set(key,callResponse.getType(),CALL_REQUEST_TTL);
        String uuid = getUUIDByUserId(to_id);
        if(uuid!=null){
            messagingTemplate.convertAndSendToUser(uuid,"/queue/callResponse",callResponse);
        }

    }


    public void candidateMessageSend(CandidateMessage candidateMessage){
        Long from_id = Long.valueOf(candidateMessage.getFrom());
        Long to_id = Long.valueOf(candidateMessage.getTo());
        if(!checkSendPermission(from_id,to_id)){
            return;
        }
        String uuid = getUUIDByUserId(to_id);
        if(uuid!=null){
            messagingTemplate.convertAndSendToUser(uuid,"/queue/signal/candidate",
                    candidateMessage);
        }
    }

    public void signalMessageSend(SignalMessage signalMessage) {
        Long from_id = Long.valueOf(signalMessage.getFrom());
        Long to_id = Long.valueOf(signalMessage.getTo());
        if(!checkSendPermission(from_id,to_id)){
            return;
        }
        String uuid = getUUIDByUserId(to_id);
        if (uuid != null) {
            if (signalMessage.getSdp().getType().equals("offer"))
                messagingTemplate.convertAndSendToUser(uuid, "/queue/signal/offer", signalMessage);
            else
                messagingTemplate.convertAndSendToUser(uuid, "/queue/signal/answer", signalMessage);

        }
    }
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Service\TimelineService.java ====
package com.example.demo.Service;



import com.example.demo.Entity.Message;
import com.example.demo.Repository.MessageRepository;
import jakarta.annotation.PostConstruct;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.data.redis.core.ZSetOperations;
import org.springframework.data.redis.core.script.DefaultRedisScript;
import org.springframework.stereotype.Service;

import java.util.*;

@Service
@RequiredArgsConstructor
@Slf4j
public class TimelineService {


    private final StringRedisTemplate redis;
    private final MessageRepository messageRepository;
    private final MessageCacheService messageCacheService;


    private final DefaultRedisScript<Long> script = new DefaultRedisScript<>();

    private static final String LUA =
            "local timeline = KEYS[1]\n" +
                    "local lastDbSeqKey = KEYS[2]\n" +
                    "local messageId = ARGV[1]\n" +
                    "local dbMaxSeq = tonumber(ARGV[2])\n" +
                    "local expireSeconds = tonumber(ARGV[3])\n" +
                    "local maxSize = tonumber(ARGV[4])\n" +
                    "local newSeq = nil\n" +
                    "local exists = redis.call('EXISTS', timeline)\n" +
                    "if exists == 1 then\n" +
                    "    local last = redis.call('ZREVRANGE', timeline, 0, 0, 'WITHSCORES')\n" +
                    "    local maxSeq = tonumber(last[2])\n" +
                    "    newSeq = maxSeq + 1\n" +
                    "else\n" +
                    "    local cached = redis.call('GET', lastDbSeqKey)\n" +
                    "    if cached then\n" +
                    "        newSeq = tonumber(cached) + 1\n" +
                    "    else\n" +
                    "        if dbMaxSeq >= 0 then\n" +
                    "            newSeq = dbMaxSeq + 1\n" +
                    "        else\n" +
                    "            newSeq = 0\n" +
                    "        end\n" +
                    "        redis.call('SET', lastDbSeqKey, newSeq, 'EX', expireSeconds)\n" +
                    "    end\n" +
                    "end\n" +
                    "redis.call('ZADD', timeline, newSeq, messageId)\n" +
                    "local size = redis.call('ZCARD', timeline)\n" +
                    "if size > maxSize then\n" +
                    "    redis.call('ZREMRANGEBYRANK', timeline, 0, size - maxSize - 1)\n" +
                    "end\n" +
                    "return newSeq";

    @PostConstruct
    public void initScriptText() {
        script.setScriptText(LUA);
        script.setResultType(Long.class);
    }

    /**
     * 添加消息并返回 seq
     */
    public long addMessage(String conversationId, Long messageId) {

        String timelineKey = "timeline:" + conversationId;
        String lastDbKey = "last_db_seq:" + conversationId;

        // Redis 无数据时 DB fallback
        Long maxSeq = messageRepository.selectMaxSeq(conversationId);
        if (maxSeq == null) maxSeq = -1L;

        Long seq = redis.execute(
                script,
                Arrays.asList(timelineKey, lastDbKey),
                String.valueOf(messageId),
                String.valueOf(maxSeq),
                String.valueOf(60),         // 缓存 60 秒
                String.valueOf(100000)      // timeline 最大容量
        );

        return seq;
    }


    public Long fetchMaxSeq(String conversationId) {

        String timelineKey = "timeline:" + conversationId;
        String lastDbKey = "last_db_seq:" + conversationId;


        // 1. Redis 里是否有 timeline ZSet
        Boolean exists = redis.hasKey(timelineKey);
        if (exists != null && exists) {
            // ZREVRANGE 0 0 WITHSCORES —— 最大 seq
            Set<ZSetOperations.TypedTuple<String>> set =
                    redis.opsForZSet().reverseRangeWithScores(timelineKey, 0, 0);

            if (set != null && !set.isEmpty()) {
                ZSetOperations.TypedTuple<String> tuple = set.iterator().next();
                return tuple.getScore().longValue();  // 最大的 seq
            }
        }

        // 2. 查 Redis 缓存的 last_db_seq
        String cached = redis.opsForValue().get(lastDbKey);
        if (cached != null) {
            try {
                return Long.parseLong(cached);
            } catch (NumberFormatException ignored) {}
        }

        // 3. 查数据库
        Long maxSeq = messageRepository.selectMaxSeq(conversationId);
        if (maxSeq != null && maxSeq >= 0) {

            return maxSeq;
        }

        // 4. 全都没有，返回 -1
        return -1L;
    }



    //获取minSeq+1 -------maxSeq之间的消息
    public List<Message> getMessages(
            String conversationId,
            Long minSeq,
            Long maxSeq
    ) {
        log.info("尝试查看{}的 seq为 {}到 {} 的消息",conversationId,minSeq,maxSeq);
        log.error("{}",conversationId);
        String key = "timeline:" + conversationId;

        List<Message> result = new ArrayList<>();

        // 一次性从 Redis 拉对应 seq 范围内的所有：seq -> messageId
        // WITHSCORES 形式：value=messageId, score=seq
        Set<ZSetOperations.TypedTuple<String>> cachedTuples =
                redis.opsForZSet().rangeByScoreWithScores(key, minSeq + 1, maxSeq);

        // 建立一个 Map<seq, messageId> 方便查找
        Map<Long, Long> redisSeqToMsgId = new HashMap<>();
        if (cachedTuples != null) {
            for (ZSetOperations.TypedTuple<String> tuple : cachedTuples) {
                Long seq = (long) tuple.getScore().longValue();
                Long messageId = Long.valueOf(tuple.getValue());
                redisSeqToMsgId.put(seq, messageId);
            }
        }

        // 遍历 minSeq+1 到 maxSeq
        for (Long seq = minSeq + 1; seq <= maxSeq; seq++) {

            if (redisSeqToMsgId.containsKey(seq)) {
                // ----- Redis 有数据：取 messageId -----
                Long messageId = redisSeqToMsgId.get(seq);

                // 根据 messageId 获取 message
                Message msg = messageCacheService.getMessageById(messageId);
                if (msg != null) {
                    result.add(msg);
                }

            } else {
                // ----- Redis 没有：走数据库，根据 seq 和 conversationId -----
                log.info("Redis 没有：走数据库，根据 seq 和 conversationId");
                Message msg = messageRepository.selectBySeqCon(seq,conversationId);
                if (msg != null) {
                    result.add(msg);
                }
            }
        }

        return result;
    }






}

==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Service\TokenService.java ====
package com.example.demo.Service;


import jakarta.annotation.Resource;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.stereotype.Service;

import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.TimeUnit;

@Service
public class TokenService {

    @Resource
    private StringRedisTemplate redis;

    private static final long TOKEN_EXPIRE = 2L; // hours

    public void saveLoginSession(Long userId, String uuid) {

        // userId -> uuid
        redis.opsForValue().set(
                "user:uuid:" + userId,
                uuid,
                TOKEN_EXPIRE,
                TimeUnit.HOURS
        );

        // uuid -> userId
        redis.opsForValue().set(
                "uuid:user:" + uuid,
                String.valueOf(userId),
                TOKEN_EXPIRE,
                TimeUnit.HOURS
        );
    }

    public Long getUserIdByUUID(String uuid) {
        String userId = redis.opsForValue().get("uuid:user:" + uuid);
        return userId == null ? null : Long.valueOf(userId);
    }

    public String getUUIDByUserId(Long userId) {
        return redis.opsForValue().get("user:uuid:" + userId);
    }

    public boolean isUUIDValid(Long userId, String uuid) {
        // Redis 中的 token 必须和传入一致
        String cachedToken = redis.opsForValue().get("user:uuid:" + userId);
        return uuid.equals(cachedToken);
    }

    public void logout(Long userId, String uuid) {
        redis.delete("user:uuid:" + userId);
        redis.delete("uuid:user:" + uuid);
    }

    public Map<Object, Object> getRefreshToken(String refreshToken){
        return redis.opsForHash().entries("refreshToken:"+refreshToken);
    }
}

==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Service\UploadService.java ====
package com.example.demo.Service;

import com.example.demo.Component.MinioProperties;
import com.example.demo.Component.MinioWorker;
import com.example.demo.DTO.UploadInitResponse;
import com.example.demo.DTO.GetFileResponse;
import com.example.demo.Entity.FileMeta;
import com.example.demo.Repository.FileMetaRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import java.io.InputStream;
import java.util.List;

@Service
@Slf4j
@RequiredArgsConstructor

public class UploadService {

    private final MinioWorker minioWorker;

    private final MinioProperties minioProperties;

    private final FileMetaRepository fileMetaRepository;

    private String generatorUploadIdKey(Long userId,String filehash){
        return "uploadId:"+userId+":"+filehash;
    }
    private String generatorKey(Long userId,String filehash){
        return userId+"/"+filehash;
    }


    public boolean easyUpload(Long userId,String filehash,String filename,Long size,String type,MultipartFile file,boolean isPrivate){
        String bucket = minioProperties.getBucket();
        String key = generatorKey(userId,filehash);
        FileMeta fileMeta = new FileMeta(filehash,filename,type,userId,size,isPrivate,bucket,true);
        fileMetaRepository.insertFileMeta(fileMeta);

        return minioWorker.easyUpload(bucket,key,file);
    }



    public UploadInitResponse initUpload(Long userId,String filehash,String filename,Long size,
                                         String type,boolean isPrivate,Integer totalParts){
        String bucket = minioProperties.getBucket();
        String key = generatorKey(userId,filehash);
        String uploadIdKey = generatorUploadIdKey(userId,filehash);
        UploadInitResponse uploadInitResponse = minioWorker.initUpload(bucket,key,totalParts,uploadIdKey);
        if(uploadInitResponse.getNewCreated()) {
            FileMeta fileMeta = new FileMeta(filehash, filename, type, userId, size, isPrivate, bucket, false);
            fileMetaRepository.insertFileMeta(fileMeta);
        }

        return uploadInitResponse;
    }

    public boolean uploadPart(Long userId, String filehash, Integer partNumber, MultipartFile chunkFile){
        String uploadIdKey = generatorUploadIdKey(userId,filehash);
        String uploadId = minioWorker.getUploadIdByKey(uploadIdKey);
        log.info("uploadPart userId={} filehash={} partNumber={} uploadId={}", userId, filehash, partNumber, uploadId);
        try(InputStream in = chunkFile.getInputStream()){
            minioWorker.uploadPart(uploadId,partNumber,in,chunkFile.getSize());
            return true;
        }catch (Exception e){
            e.printStackTrace();
            return false;
        }

    }


    public List<Integer> getMissingParts(Long userId, String filehash){
        String uploadIdKey = generatorUploadIdKey(userId,filehash);
        String uploadId = minioWorker.getUploadIdByKey(uploadIdKey);
        log.info("getMissingParts userId={} filehash={} uploadId={}", userId, filehash, uploadId);
        return minioWorker.getMissingParts(uploadId);
    }

    public boolean completeUpload(Long userId, String filehash){
        String uploadIdKey = generatorUploadIdKey(userId,filehash);
        String uploadId = minioWorker.getUploadIdByKey(uploadIdKey);
        log.info("completeUpload userId={} filehash={} uploadId={}", userId, filehash, uploadId);

        if(minioWorker.completeUpload(uploadId)){
            fileMetaRepository.updateIsCompleted(userId,filehash,true);
            return true;
        }else{
            return false;
        }
    }


    public GetFileResponse getUrl(Long userId, String filehash){
        FileMeta fileMeta = fileMetaRepository.selectFileMeta(userId,filehash);
        String bucket = fileMeta.getBucket();
        String key = generatorKey(userId,filehash);
        String url =  minioWorker.getUrl(bucket,key,minioProperties.getEndpoint(),minioProperties.getAccessKey(),minioProperties.getSecretKey());
        GetFileResponse getFileResponse = new GetFileResponse(url,fileMeta.getFilename(),fileMeta.getType(),fileMeta.getSize());
        return getFileResponse;

    }

}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Service\UserService.java ====
package com.example.demo.Service;


import com.example.demo.DTO.UserSearch;
import com.example.demo.Entity.Storage;
import com.example.demo.Repository.StorageRepository;
import com.example.demo.VO.UserInfo;
import com.example.demo.Entity.User;
import com.example.demo.Repository.UserRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.redisson.api.RLock;
import org.redisson.api.RedissonClient;
import org.springframework.data.redis.core.RedisCallback;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.stereotype.Service;

import java.time.Duration;
import java.util.*;
import java.util.concurrent.TimeUnit;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
@Slf4j
public class UserService {

    private final StringRedisTemplate redisTemplate;

    private final RedissonClient redissonClient; // 使用Redisson做分布式锁

    private final UserRepository userRepository;
    private final StorageRepository storageRepository;
    private final MessageCacheService messageCacheService;

    private static final String CACHE_KEY_PREFIX = "userInfo:";
    private static final long EXPIRE_TIME = 1L; // 1天
    private static final TimeUnit EXPIRE_UNIT = TimeUnit.DAYS;
    private static final String NULL_MARK_FIELD = "_isNull";


    // --- 辅助方法：Map 与 Object 转换 ---
    private UserInfo mapToUserInfo(Long id, Map<Object, Object> entries) {
        return new UserInfo(id,(String) entries.get("account"),(String) entries.get("name"),
                (String) entries.get("avatar"),(String) entries.get("signature"));
    }

    private Map<String, String> userInfoToMap(UserInfo user) {
        Map<String, String> map = new HashMap<>();
        if (user.getAccount() != null) map.put("account", user.getAccount());
        if (user.getName() != null) map.put("name", user.getName());
        if (user.getAvatar() != null) map.put("avatar", user.getAvatar());
        if (user.getSignature() != null) map.put("signature", user.getSignature());
        return map;
    }

    // 为 Pipeline 准备的 Byte Map
    private Map<byte[], byte[]> userInfoToByteMap(UserInfo user) {
        Map<byte[], byte[]> map = new HashMap<>();
        if (user.getAccount() != null) map.put("account".getBytes(), user.getAccount().getBytes());
        if (user.getName() != null) map.put("name".getBytes(), user.getName().getBytes());
        // ... 其他字段
        return map;
    }


    //=================================================METHOD===========================================================


    //获取单个用户信息（含缓存、锁、防穿透）
    public UserInfo getUserInfo(Long userId) {
        String key = CACHE_KEY_PREFIX + userId;
        Map<Object, Object> entries = redisTemplate.opsForHash().entries(key);
        if (!entries.isEmpty()) {
            if (entries.containsKey(NULL_MARK_FIELD)) {
                redisTemplate.expire(key, EXPIRE_TIME, EXPIRE_UNIT);
                log.warn("此用户为空，在此防穿刺");
                return null;
            }
            UserInfo userInfo = mapToUserInfo(userId, entries);
            redisTemplate.expire(key, EXPIRE_TIME, EXPIRE_UNIT);
            log.info("redis找到用户");
            return userInfo;
        }

        String lockKey = "lock:user:" + userId;
        RLock lock = redissonClient.getLock(lockKey);
        int retry = 0;

        while (retry <= 5) {
            try {
                boolean isLocked = lock.tryLock(500, 10000, TimeUnit.MILLISECONDS);
                if (isLocked) {
                    try {
                        entries = redisTemplate.opsForHash().entries(key);
                        if (!entries.isEmpty()) {
                            if (entries.containsKey(NULL_MARK_FIELD)) {
                                return null;
                            }
                            return mapToUserInfo(userId, entries);
                        }

                        UserInfo userInfo = userRepository.selectInfoById(userId);
                        if (userInfo != null) {
                            Map<String, String> hash = userInfoToMap(userInfo);
                            redisTemplate.opsForHash().putAll(key, hash);
                            redisTemplate.expire(key, EXPIRE_TIME, EXPIRE_UNIT);
                            log.info("数据库查到用户信息，并缓存");
                            return userInfo;
                        } else {
                            redisTemplate.opsForHash().put(key, NULL_MARK_FIELD, "true");
                            redisTemplate.expire(key, EXPIRE_TIME, EXPIRE_UNIT);
                            log.warn("此用户不存在，在此设空标防穿刺");
                            return null;
                        }
                    } finally {
                        lock.unlock();
                    }
                } else {
                    retry++;
                    Thread.sleep(200);
                }
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
                break;
            }
        }
        return null;
    }


    //批量获取用户信息 (Pipeline 优化)
    public List<UserInfo> batchGetUserInfo(List<Long> userIds) {
        if (userIds == null || userIds.isEmpty()) return Collections.emptyList();

        // 去重
        List<Long> uniqueIds = userIds.stream().distinct().toList();
        List<UserInfo> resultList = new ArrayList<>();
        List<Long> missIds = new ArrayList<>();

        // 1. 使用 Pipeline 批量读取 Redis
        List<Object> pipelineResults = redisTemplate.executePipelined((RedisCallback<Object>)  connection-> {
            for (Long id : uniqueIds) {
                String key = CACHE_KEY_PREFIX + id;
                connection.hashCommands().hGetAll(key.getBytes());
                // 顺便批量刷新过期时间（Best Effort）
                connection.keyCommands().expire(key.getBytes(), EXPIRE_UNIT.toSeconds(EXPIRE_TIME));

            }
            return null;
        });

        // 2. 解析 Pipeline 结果
        for (int i = 0; i < uniqueIds.size(); i++) {
            Long userId = uniqueIds.get(i);
            @SuppressWarnings("unchecked")
            Map<Object, Object> entries = (Map<Object, Object>) pipelineResults.get(i); // hGetAll 结果

            if (entries == null || entries.isEmpty()) {
                missIds.add(userId);
            } else {
                if (entries.containsKey(NULL_MARK_FIELD)) {
                    // 缓存了空对象，结果集里放null或者跳过，视业务需求定
                    resultList.add(null);
                } else {
                    resultList.add(mapToUserInfo(userId, entries));
                }
            }
        }

        // 3. 处理缓存未命中的 ID (批量查库)
        if (!missIds.isEmpty()) {
            List<UserInfo> userInfos = userRepository.selectByIdList(missIds);
            Map<Long, UserInfo> dbUserMap = userInfos.stream()
                    .collect(Collectors.toMap(UserInfo::getId, u -> u));

            // 4. 将查到的数据回写 Redis (使用 Pipeline 批量写)
            redisTemplate.executePipelined((RedisCallback<Object>) connection -> {
                for (Long missId : missIds) {
                    UserInfo u = dbUserMap.get(missId);
                    String key = CACHE_KEY_PREFIX + missId;

                    if (u != null) {
                        Map<byte[], byte[]> hash = userInfoToByteMap(u);
                        connection.hashCommands().hMSet(key.getBytes(),hash);
                    } else {
                        // 数据库也没有，批量写入空对象
                        connection.hashCommands().hSet(key.getBytes(), NULL_MARK_FIELD.getBytes(), "true".getBytes());
                    }
                    connection.keyCommands().expire(key.getBytes(), EXPIRE_UNIT.toSeconds(EXPIRE_TIME));
                }
                return null;
            });

            // 将 DB 查到的结果加入最终返回列表
            // 注意：这里需要保证返回顺序或仅返回存在的，视业务逻辑而定
            for (Long missId : missIds) {
                resultList.add(dbUserMap.get(missId)); // 如果是null也会add null
            }
        }

        return resultList;
    }


    //修改用户信息，使用旁路加载
    public void changeAvatar(Long userId,String newAvatar){
        String key = CACHE_KEY_PREFIX+userId;
        userRepository.updateAvatar(userId,newAvatar);
        if(redisTemplate.hasKey(key)){
            redisTemplate.delete(key);
        }
    }

    public void changeSignature(Long user_id,String newSignature){
        String key = CACHE_KEY_PREFIX+user_id;
        userRepository.updateSignature(user_id,newSignature);
        if(redisTemplate.hasKey(key)){
            redisTemplate.delete(key);
        }
    }

    public void changeName(Long user_id,String newName){
        String key = CACHE_KEY_PREFIX+user_id;
        userRepository.updateName(user_id,newName);
        if(redisTemplate.hasKey(key)){
            redisTemplate.delete(key);
        }
    }

    //查看用户信息
    private Long getIdByAccount(String account){
        String user_id_str = redisTemplate.opsForValue().get("account:"+account);
        if(user_id_str == null){//redis中没有
            Long user_id = userRepository.selectIdByAccount(account);
            if(user_id == null){//伪造用户
                redisTemplate.opsForValue().set("account:"+account,NULL_MARK_FIELD, Duration.ofDays(1));
                return null;
            }else{//真实用户
                redisTemplate.opsForValue().set("account:"+account,String.valueOf(user_id));
                return user_id;
            }
        } else if (user_id_str.equals(NULL_MARK_FIELD)) {//查询伪造用户
            return null;
        }else{//redis查到用户
            return Long.valueOf(user_id_str);
        }
    }


    //根据account查询用户信息以及关系
    public UserSearch searchByAccount(String account,Long user_id){
        Long id = getIdByAccount(account);
        if(id == null){
            log.info("查不到id，该用户不存在");
            return null;
        }
        UserInfo userInfo = getUserInfo(id);
        if(userInfo == null){
            log.warn("未查到用户");
            return null;
        }
        log.info("{}",userInfo.getAccount());
        boolean isFriend = messageCacheService.hasRelationsNoDb(user_id,id,"FRIEND");
        log.info("{}",isFriend);
        UserSearch userSearch = new UserSearch();
        userSearch.setUserInfo(userInfo);
        userSearch.setFriend(isFriend);
        return userSearch;
    }

    //根据userid获得storage列表
    public List<Storage>getStorage(Long userId,String type,Integer limit,Integer offset){
        if(type.equals("all")){
            return storageRepository.selectStorage(userId,null,limit,offset);
        }
        return storageRepository.selectStorage(userId,type,limit,offset);

    }


}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Tools\AuthUtil.java ====
package com.example.demo.Tools;

import org.springframework.security.core.context.SecurityContextHolder;

public class AuthUtil {
    public static String getUserId(){
        var context = SecurityContextHolder.getContext();
        if (context == null || context.getAuthentication() == null) {
            return null;
        }
        Object principal = context.getAuthentication().getPrincipal();
        return principal == null ? null : (String) principal;
    }
}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Tools\CodeUtil.java ====
package com.example.demo.Tools;

import java.util.Random;

public class CodeUtil {
    public static String generateCode(){
        return String.valueOf((int)((Math.random()*9+1)*100000)); //6位随机验证码
    }


    public static String randomNumeric(int count) {
        Random random = new Random();
        StringBuilder sb = new StringBuilder();
        for (int i = 0; i < count; i++) {
            sb.append(random.nextInt(10));
        }
        return sb.toString();
    }

}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\Tools\PasswordUtil.java ====
package com.example.demo.Tools;

import org.springframework.security.crypto.argon2.Argon2PasswordEncoder;

/**
 * 密码工具类 —— 使用 Argon2 加密和校验
 */
public class PasswordUtil {

    // 可以调整参数：盐长度、哈希长度、迭代次数、内存成本、并行度
    private static final int SALT_LENGTH = 16;
    private static final int HASH_LENGTH = 32;
    private static final int ITERATIONS = 3;
    private static final int MEMORY = 65536; // KB
    private static final int PARALLELISM = 1;

    private static final Argon2PasswordEncoder encoder = new Argon2PasswordEncoder(
            SALT_LENGTH, HASH_LENGTH, ITERATIONS, MEMORY, PARALLELISM
    );


    //对明文密码进行不可逆加密

    public static String hash(String rawPassword) {
        return encoder.encode(rawPassword);
    }


    //校验明文密码和加密后的哈希是否匹配
    public static boolean verify(String rawPassword, String hashedPassword) {
        return encoder.matches(rawPassword, hashedPassword);
    }

}

==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\VO\GroupShortInfo.java ====
package com.example.demo.VO;

import lombok.Data;

@Data
public class GroupShortInfo {
    private Long id;
    private String name;
    private String avatar;
    private String signature;
    private Integer member_count;

    public GroupShortInfo(Long id,String name,String avatar,String signature,Integer member_count){
        this.id = id;
        this.name = name;
        this.avatar = avatar;
        this.signature = signature;
        this.member_count = member_count;
    }

}


==== C:\Users\ml323\Desktop\IM_TEST\demo\src\main\java\com\example\demo\VO\UserInfo.java ====
package com.example.demo.VO;

import com.fasterxml.jackson.databind.annotation.JsonSerialize;
import com.fasterxml.jackson.databind.ser.std.ToStringSerializer;
import lombok.Data;

@Data
public class UserInfo {
    @JsonSerialize(using = ToStringSerializer.class)
    private Long id;
    private String account;
    private String name;
    private String avatar;
    private String signature;

    public UserInfo(Long id,String account,String name,String avatar,String signature){
        this.id = id;
        this.account = account;
        this.name = name;
        this.avatar = avatar;
        this.signature = signature;
    }
}

